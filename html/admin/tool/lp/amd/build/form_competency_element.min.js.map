{"version":3,"file":"form_competency_element.min.js","sources":["../src/form_competency_element.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Badge select competency actions\n *\n * @module     tool_lp/form_competency_element\n * @copyright  2019 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'tool_lp/competencypicker', 'core/ajax', 'core/notification', 'core/templates'],\n        function($, Picker, Ajax, Notification, Templates) {\n\n    var pickerInstance = null;\n\n    var pageContextId = 1;\n\n    /**\n     * Re-render the list of selected competencies.\n     *\n     * @method renderCompetencies\n     * @return {boolean}\n     */\n    var renderCompetencies = function() {\n        var currentCompetencies = $('[data-action=\"competencies\"]').val();\n        var requests = [];\n        var i = 0;\n\n        if (currentCompetencies != '') {\n            currentCompetencies = currentCompetencies.split(',');\n            for (i = 0; i < currentCompetencies.length; i++) {\n                requests[requests.length] = {\n                    methodname: 'core_competency_read_competency',\n                    args: {id: currentCompetencies[i]}\n                };\n            }\n        }\n\n        $.when.apply($, Ajax.call(requests, false)).then(function() {\n            var i = 0,\n                competencies = [];\n\n            for (i = 0; i < arguments.length; i++) {\n                competencies[i] = arguments[i];\n            }\n            var context = {\n                competencies: competencies\n            };\n\n            return Templates.render('tool_lp/form_competency_list', context);\n        }).then(function(html, js) {\n            Templates.replaceNode($('[data-region=\"competencies\"]'), html, js);\n            return true;\n        }).fail(Notification.exception);\n\n        return true;\n    };\n\n    /**\n     * Deselect a competency\n     *\n     * @method unpickCompetenciesHandler\n     * @param {Event} e\n     * @return {boolean}\n     */\n    var unpickCompetenciesHandler = function(e) {\n        var currentCompetencies = $('[data-action=\"competencies\"]').val().split(','),\n            newCompetencies = [],\n            i,\n            toRemove = $(e.currentTarget).data('id');\n\n        for (i = 0; i < currentCompetencies.length; i++) {\n            if (currentCompetencies[i] != toRemove) {\n                newCompetencies[newCompetencies.length] = currentCompetencies[i];\n            }\n        }\n\n        $('[data-action=\"competencies\"]').val(newCompetencies.join(','));\n\n        return renderCompetencies();\n    };\n\n    /**\n     * Open a competencies popup to relate competencies.\n     *\n     * @method pickCompetenciesHandler\n     */\n    var pickCompetenciesHandler = function() {\n        var currentCompetencies = $('[data-action=\"competencies\"]').val().split(',');\n\n        if (!pickerInstance) {\n            pickerInstance = new Picker(pageContextId, false, 'parents', true);\n            pickerInstance.on('save', function(e, data) {\n                var before = $('[data-action=\"competencies\"]').val();\n                var compIds = data.competencyIds;\n                if (before != '') {\n                    compIds = compIds.concat(before.split(','));\n                }\n                var value = compIds.join(',');\n\n                $('[data-action=\"competencies\"]').val(value);\n\n                return renderCompetencies();\n            });\n        }\n\n        pickerInstance.setDisallowedCompetencyIDs(currentCompetencies);\n        pickerInstance.display();\n    };\n\n    return /** @alias module:tool_lp/form_competency_element */ {\n        /**\n         * Listen for clicks on the competency picker and push the changes to the form element.\n         *\n         * @method init\n         * @param {Integer} contextId\n         */\n        init: function(contextId) {\n            pageContextId = contextId;\n            renderCompetencies();\n            $('[data-action=\"select-competencies\"]').on('click', pickCompetenciesHandler);\n            $('body').on('click', '[data-action=\"deselect-competency\"]', unpickCompetenciesHandler);\n        }\n    };\n});\n"],"names":["define","$","Picker","Ajax","Notification","Templates","pickerInstance","pageContextId","renderCompetencies","currentCompetencies","val","requests","i","split","length","methodname","args","id","when","apply","call","then","competencies","arguments","context","render","html","js","replaceNode","fail","exception","unpickCompetenciesHandler","e","newCompetencies","toRemove","currentTarget","data","join","pickCompetenciesHandler","on","before","compIds","competencyIds","concat","value","setDisallowedCompetencyIDs","display","init","contextId"],"mappings":";;;;;;;AAsBAA,yCAAO,CAAC,SAAU,2BAA4B,YAAa,oBAAqB,mBACxE,SAASC,EAAGC,OAAQC,KAAMC,aAAcC,eAExCC,eAAiB,KAEjBC,cAAgB,EAQhBC,mBAAqB,eACjBC,oBAAsBR,EAAE,gCAAgCS,MACxDC,SAAW,GACXC,EAAI,KAEmB,IAAvBH,wBACAA,oBAAsBA,oBAAoBI,MAAM,KAC3CD,EAAI,EAAGA,EAAIH,oBAAoBK,OAAQF,IACxCD,SAASA,SAASG,QAAU,CACxBC,WAAY,kCACZC,KAAM,CAACC,GAAIR,oBAAoBG,YAK3CX,EAAEiB,KAAKC,MAAMlB,EAAGE,KAAKiB,KAAKT,UAAU,IAAQU,MAAK,eACzCT,EAAI,EACJU,aAAe,OAEdV,EAAI,EAAGA,EAAIW,UAAUT,OAAQF,IAC9BU,aAAaV,GAAKW,UAAUX,OAE5BY,QAAU,CACVF,aAAcA,qBAGXjB,UAAUoB,OAAO,+BAAgCD,YACzDH,MAAK,SAASK,KAAMC,WACnBtB,UAAUuB,YAAY3B,EAAE,gCAAiCyB,KAAMC,KACxD,KACRE,KAAKzB,aAAa0B,YAEd,GAUPC,0BAA4B,SAASC,OAGjCpB,EAFAH,oBAAsBR,EAAE,gCAAgCS,MAAMG,MAAM,KACpEoB,gBAAkB,GAElBC,SAAWjC,EAAE+B,EAAEG,eAAeC,KAAK,UAElCxB,EAAI,EAAGA,EAAIH,oBAAoBK,OAAQF,IACpCH,oBAAoBG,IAAMsB,WAC1BD,gBAAgBA,gBAAgBnB,QAAUL,oBAAoBG,WAItEX,EAAE,gCAAgCS,IAAIuB,gBAAgBI,KAAK,MAEpD7B,sBAQP8B,wBAA0B,eACtB7B,oBAAsBR,EAAE,gCAAgCS,MAAMG,MAAM,KAEnEP,iBACDA,eAAiB,IAAIJ,OAAOK,eAAe,EAAO,WAAW,IAC9CgC,GAAG,QAAQ,SAASP,EAAGI,UAC9BI,OAASvC,EAAE,gCAAgCS,MAC3C+B,QAAUL,KAAKM,cACL,IAAVF,SACAC,QAAUA,QAAQE,OAAOH,OAAO3B,MAAM,WAEtC+B,MAAQH,QAAQJ,KAAK,YAEzBpC,EAAE,gCAAgCS,IAAIkC,OAE/BpC,wBAIfF,eAAeuC,2BAA2BpC,qBAC1CH,eAAewC,iBAGyC,CAOxDC,KAAM,SAASC,WACXzC,cAAgByC,UAChBxC,qBACAP,EAAE,uCAAuCsC,GAAG,QAASD,yBACrDrC,EAAE,QAAQsC,GAAG,QAAS,sCAAuCR"}