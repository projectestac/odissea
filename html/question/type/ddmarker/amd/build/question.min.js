define ("qtype_ddmarker/question",["jquery","core/dragdrop","qtype_ddmarker/shapes","core/key_codes"],function(a,b,c,d){"use strict";function e(a,b,c,d){this.containerId=a;this.visibleDropZones=d;if(c){this.getRoot().addClass("qtype_ddmarker-readonly")}this.loadImage(b)}e.prototype.loadImage=function(a){var b=this;this.getRoot().find(".dropbackground").one("load",function(){if(0<b.visibleDropZones.length){b.drawDropzones()}b.repositionDrags()}).attr("src",a).css({border:"1px solid #000","max-width":"none"})};e.prototype.drawDropzones=function(){var a=this.getRoot().find("img.dropbackground");this.getRoot().find("div.dropzones").html("<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"dropzones\" width=\""+a.outerWidth()+"\" height=\""+a.outerHeight()+"\"></svg>");var b=this.getRoot().find("svg.dropzones");b.css("position","absolute");for(var c=0,d=0,e;d<this.visibleDropZones.length;d++){e="color"+c;c=(c+1)%8;this.addDropzone(b,d,e)}};e.prototype.addDropzone=function(a,b,d){var e=this.visibleDropZones[b],f=c.make(e.shape,""),g;if(!f.parse(e.coords)){return}g=this.getRoot().find("div.markertexts span.markertext"+b);if(g.length){if(""!==e.markertext){g.html(e.markertext)}else{g.remove()}}else if(""!==e.markertext){this.getRoot().find("div.markertexts").append("<span class=\""+("markertext markertext"+b)+"\">"+e.markertext+"</span>")}var h=f.makeSvg(a[0]);h.setAttribute("class","dropzone "+d)};e.prototype.repositionDropZones=function(){var a=this.getRoot().find("svg.dropzones");if(0===a.length){return}var b=this.convertToWindowXY(new c.Point(-1,0));a.offset({left:b.x,top:b.y});for(var d=0,e;d<this.visibleDropZones.length;d++){e=this.getRoot().find("div.ddarea div.markertexts span.markertext"+d);if(0===e.length){continue}var f=this.visibleDropZones[d],g=c.make(f.shape,"");if(!g.parse(f.coords)){continue}var h=g.getHandlePositions(),i=this.convertToWindowXY(h.moveHandle.offset(-e.outerWidth()/2,-e.outerHeight()/2));e.offset({left:i.x-4,top:i.y})}};e.prototype.repositionDrags=function(){var b=this.getRoot(),c=this;b.find("div.dragitems .dragitem").each(function(b,c){a(c).addClass("unneeded")});b.find("input.choices").each(function(a,b){for(var d=c.getChoiceNoFromElement(b),e=c.getCoords(b),f=c.dragHome(d),g=0,h;g<e.length;g++){h=c.dragItem(d,g);if(!h.length||h.hasClass("beingdragged")){h=c.cloneNewDragItem(f,g)}else{h.removeClass("unneeded")}h.offset({left:e[g].x,top:e[g].y})}});b.find("div.dragitems .dragitem").each(function(b,c){var d=a(c);if(d.hasClass("unneeded")&&!d.hasClass("beingdragged")){d.remove()}});this.repositionDropZones();var d=this.bgImage(),e=d.offset();d.data("prev-top",e.top).data("prev-left",e.left)};e.prototype.getCoords=function(b){var d=this.getRoot(),e=this.getChoiceNoFromElement(b),f=+this.getClassnameNumericSuffix(b,"noofdrags"),g=0<d.find("span.dragitem.beingdragged.choice"+e).length,h=[],j=a(b).val();if(""!==j){for(var k=j.split(";"),l=0;l<k.length;l++){h[l]=this.convertToWindowXY(c.Point.parse(k[l]))}}var m=h.length+(g?1:0);if(a(b).hasClass("infinite")||m<f){h[h.length]=this.dragHomeXY(e)}return h};e.prototype.convertToWindowXY=function(a){var b=this.bgImage();return a.offset(b.offset().left+1,b.offset().top+1)};e.prototype.convertToBgImgXY=function(a){var b=this.bgImage();return a.offset(-b.offset().left-1,-b.offset().top-1)};e.prototype.coordsInBgImg=function(a){var b=this.bgImage();return 0<a.x&&a.x<=b.width()&&0<a.y&&a.y<=b.height()};e.prototype.dragHomeXY=function(a){var b=this.dragHome(a);return new c.Point(b.offset().left,b.offset().top)};e.prototype.getRoot=function(){return a(document.getElementById(this.containerId))};e.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")};e.prototype.dragHome=function(a){return this.getRoot().find("div.dragitems span.draghome.choice"+a)};e.prototype.dragItem=function(a,b){return this.getRoot().find("div.dragitems span.dragitem.choice"+a+".item"+b)};e.prototype.cloneNewDragItem=function(a,b){var c=a.clone(!0);c.removeClass("draghome").addClass("dragitem").addClass("item"+b);a.after(c);c.attr("tabIndex",0);return c};e.prototype.handleDragStart=function(c){var d=this,e=a(c.target).closest(".dragitem"),f=b.prepare(c);if(!f.start){return}e.addClass("beingdragged");b.start(c,e,function(){},function(a,b,c){d.dragEnd(c)})};e.prototype.dragEnd=function(a){a.removeClass("beingdragged");var b=this.getChoiceNoFromElement(a);this.saveCoordsForChoice(b,a);this.repositionDrags()};e.prototype.saveCoordsForChoice=function(a,b){for(var d=[],e=this.getRoot().find("span.dragitem.choice"+a).length,f,g=!0,h=0,j;h<=e;h++){j=this.dragItem(a,h);if(0===j.length){continue}if(!j.hasClass("beingdragged")){f=this.convertToBgImgXY(new c.Point(j.offset().left,j.offset().top));if(this.coordsInBgImg(f)){d[d.length]=f}}if(b&&0!==b.length&&b[0].innerText===j[0].innerText){g=!1}}if(g){f=this.convertToBgImgXY(new c.Point(b.offset().left,b.offset().top));if(this.coordsInBgImg(f)){d[d.length]=f}}this.getRoot().find("input.choice"+a).val(d.join(";"))};e.prototype.handleKeyPress=function(b){var e=a(b.target).closest(".dragitem"),f=new c.Point(e.offset().left,e.offset().top),g=this.getChoiceNoFromElement(e);switch(b.keyCode){case d.arrowLeft:case 65:f.x-=1;break;case d.arrowRight:case 68:f.x+=1;break;case d.arrowDown:case 83:f.y+=1;break;case d.arrowUp:case 87:f.y-=1;break;case d.space:case d.escape:f=null;break;default:return;}b.preventDefault();if(null!==f){f=this.constrainToBgImg(f)}else{f=this.dragHomeXY(g)}e.offset({left:f.x,top:f.y});this.saveCoordsForChoice(g,e);this.repositionDrags()};e.prototype.constrainToBgImg=function(a){var b=this.bgImage(),c=this.convertToBgImgXY(a);c.x=Math.max(0,c.x);c.y=Math.max(0,c.y);c.x=Math.min(b.width(),c.x);c.y=Math.min(b.height(),c.y);return this.convertToWindowXY(c)};e.prototype.getChoiceNoFromElement=function(a){return+this.getClassnameNumericSuffix(a,"choice")};e.prototype.getClassnameNumericSuffix=function(b,c){var d=a(b).attr("class");if(d!==void 0&&""!==d){for(var e=d.split(" "),f=0,g;f<e.length;f++){g=new RegExp("^"+c+"([0-9])+$");if(g.test(e[f])){var h=/([0-9])+$/,i=h.exec(e[f]);return+i[0]}}}return null};e.prototype.handleResize=function(){this.repositionDrags()};e.prototype.fixLayoutIfBackgroundMoved=function(){var a=this.bgImage(),b=a.offset(),c=a.data("prev-top"),d=a.data("prev-left");if(d===void 0||c===void 0){return}if(c===b.top&&d===b.left){return}this.repositionDrags()};var f={eventHandlersInitialised:!1,questions:{},init:function init(a,b,c,d){f.questions[a]=new e(a,b,c,d);if(!f.eventHandlersInitialised){f.setupEventHandlers();f.eventHandlersInitialised=!0}},setupEventHandlers:function setupEventHandlers(){a("body").on("mousedown touchstart",".que.ddmarker:not(.qtype_ddmarker-readonly) div.dragitems .dragitem",f.handleDragStart).on("keydown keypress",".que.ddmarker:not(.qtype_ddmarker-readonly) div.dragitems .dragitem",f.handleKeyPress);a(window).on("resize",f.handleWindowResize);setTimeout(f.fixLayoutIfThingsMoved,100)},handleDragStart:function handleDragStart(a){a.preventDefault();var b=f.getQuestionForEvent(a);if(b){b.handleDragStart(a)}},handleKeyPress:function handleKeyPress(a){var b=f.getQuestionForEvent(a);if(b){b.handleKeyPress(a)}},handleWindowResize:function handleWindowResize(){for(var a in f.questions){if(f.questions.hasOwnProperty(a)){f.questions[a].handleResize()}}},fixLayoutIfThingsMoved:function fixLayoutIfThingsMoved(){for(var a in f.questions){if(f.questions.hasOwnProperty(a)){f.questions[a].fixLayoutIfBackgroundMoved()}}setTimeout(f.fixLayoutIfThingsMoved,100)},getQuestionForEvent:function getQuestionForEvent(b){var c=a(b.currentTarget).closest(".que.ddmarker").attr("id");return f.questions[c]}};return{init:f.init}});
//# sourceMappingURL=question.min.js.map
