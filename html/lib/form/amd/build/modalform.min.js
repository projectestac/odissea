define ("core_form/modalform",["exports","core/modal_factory","core/modal_events","core/ajax","core/notification","core/yui","core/event","core/fragment","core/pending"],function(a,b,c,d,e,f,g,h,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=j(b);c=j(c);d=j(d);e=j(e);f=j(f);g=j(g);h=j(h);i=j(i);function j(a){return a&&a.__esModule?a:{default:a}}function k(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function l(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){k(h,d,e,f,g,"next",a)}function g(a){k(h,d,e,f,g,"throw",a)}f(void 0)})}}function m(a){return q(a)||p(a)||o(a)||n()}function n(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(a,b){if(!a)return;if("string"==typeof a)return r(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return r(a,b)}function p(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function q(a){if(Array.isArray(a))return r(a)}function r(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function s(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);if(b)d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable});c.push.apply(c,d)}return c}function t(a){for(var b=1,c;b<arguments.length;b++){c=null!=arguments[b]?arguments[b]:{};if(b%2){s(Object(c),!0).forEach(function(b){x(a,b,c[b])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(a,Object.getOwnPropertyDescriptors(c))}else{s(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}}return a}function u(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function v(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function w(a,b,c){if(b)v(a.prototype,b);if(c)v(a,c);return a}function x(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var y=function(){function a(c){u(this,a);x(this,"events",{FORM_SUBMITTED:"core_form_modalform_formsubmitted",FORM_CANCELLED:"core_form_modalform_formcancelled",CLIENT_VALIDATION_ERROR:"core_form_modalform_clientvalidationerror",SERVER_VALIDATION_ERROR:"core_form_modalform_validationerror",ERROR:"core_form_modalform_error",NOSUBMIT_BUTTON_PRESSED:"core_form_modalform_nosubmitbutton",SUBMIT_BUTTON_PRESSED:"core_form_modalform_submitbutton",CANCEL_BUTTON_PRESSED:"core_form_modalform_cancelbutton",LOADED:"core_form_modalform_loaded"});this.modal=null;this.config=c;this.config.modalConfig=t({removeOnClose:!0,type:b.default.types.SAVE_CANCEL,large:!0},this.config.modalConfig||{});this.config.args=this.config.args||{};this.futureListeners=[]}w(a,[{key:"show",value:function show(){var a=this,d=new i.default("core_form/modalform:init");return b.default.create(this.config.modalConfig).then(function(b){a.modal=b;var d=new URLSearchParams(Object.entries(a.config.args||{})),f=a.getBody(d.toString());a.modal.setBodyContent(f);f.catch(e.default.exception);a.modal.getRoot().on(c.default.hidden,function(){a.notifyResetFormChanges().then(function(){a.modal.destroy();if(a.config.returnFocus){a.config.returnFocus.focus()}return null}).catch(function(){return null})});a.modal.getModal().addClass("modal-form-dialogue");a.modal.getRoot().on("click","form input[type=submit][data-no-submit]",function(b){b.preventDefault();var c=a.trigger(a.events.NOSUBMIT_BUTTON_PRESSED,b.target);if(!c.defaultPrevented){a.processNoSubmitButton(b.target)}});a.modal.getRoot().on("submit","form",function(b){b.preventDefault();var c=a.trigger(a.events.SUBMIT_BUTTON_PRESSED);if(!c.defaultPrevented){a.submitFormAjax()}});if("undefined"!=typeof a.config.saveButtonText&&"undefined"!=typeof a.modal.setSaveButtonText){a.modal.setSaveButtonText(a.config.saveButtonText)}if("undefined"!=typeof a.config.saveButtonClasses){a.setSaveButtonClasses(a.config.saveButtonClasses)}a.modal.getRoot().on(c.default.save,function(b){b.preventDefault();a.modal.getRoot().find("form").submit()});a.modal.getRoot().on(c.default.cancel,function(b){var c=a.trigger(a.events.CANCEL_BUTTON_PRESSED);if(c.defaultPrevented){b.preventDefault()}});a.futureListeners.forEach(function(b){var c;return(c=a.modal.getRoot()[0]).addEventListener.apply(c,m(b))});a.futureListeners=[];a.trigger(a.events.LOADED,null,!1);return a.modal.show()}).then(d.resolve)}},{key:"trigger",value:function trigger(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!0,d=new CustomEvent(a,{detail:b,cancelable:c});this.modal.getRoot()[0].dispatchEvent(d);return d}},{key:"addEventListener",value:function addEventListener(){for(var a=arguments.length,b=Array(a),c=0;c<a;c++){b[c]=arguments[c]}if(!this.modal){this.futureListeners.push(b)}else{var d;(d=this.modal.getRoot()[0]).addEventListener.apply(d,b)}}},{key:"getBody",value:function getBody(a){var b={formdata:a,form:this.config.formClass},c=new i.default("core_form/modalform:form_body");return d.default.call([{methodname:"core_form_dynamic_form",args:b}])[0].then(function(a){c.resolve();return{html:a.html,js:h.default.processCollectedJavascript(a.javascript)}})}},{key:"onSubmitError",value:function onSubmitError(a){var b=this.trigger(this.events.ERROR,a);if(b.defaultPrevented){return}e.default.exception(a)}},{key:"notifyResetFormChanges",value:function notifyResetFormChanges(){var a=this;return new Promise(function(b){f.default.use("event","moodle-core-event","moodle-core-formchangechecker",function(){var c=a.modal.getRoot().find("form")[0];if(c){g.default.notifyFormSubmitAjax(c,!0);M.core_formchangechecker.reset_form_dirty_state()}b()})})}},{key:"notifyFormSubmitAjax",value:function notifyFormSubmitAjax(){var a=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;return new Promise(function(c){f.default.use("event","moodle-core-event","moodle-core-formchangechecker",function(){g.default.notifyFormSubmitAjax(a.modal.getRoot().find("form")[0],b);c()})})}},{key:"processNoSubmitButton",value:function processNoSubmitButton(a){var b=this;this.notifyFormSubmitAjax(!0).then(function(){var c=b.modal.getRoot().find("form").serialize();c=c+"&"+encodeURIComponent(a.getAttribute("name"))+"="+encodeURIComponent(a.getAttribute("value"));var d=b.getBody(c);b.modal.setBodyContent(d);d.catch(e.default.exception);return null}).catch(null)}},{key:"validateElements",value:function validateElements(){var a=this;return this.notifyFormSubmitAjax().then(function(){var b=a.modal.getRoot().find("[aria-invalid=\"true\"], .error");if(b.length){b.first().focus();return!1}return!0})}},{key:"disableButtons",value:function disableButtons(){this.modal.getFooter().find("[data-action]").attr("disabled",!0)}},{key:"enableButtons",value:function enableButtons(){this.modal.getFooter().find("[data-action]").removeAttr("disabled")}},{key:"submitFormAjax",value:function(){var a=l(regeneratorRuntime.mark(function a(){var b=this,c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.validateElements();case 2:if(a.sent){a.next=5;break}this.trigger(this.events.CLIENT_VALIDATION_ERROR,null,!1);return a.abrupt("return");case 5:this.disableButtons();c=this.modal.getRoot().find("form").serialize();d.default.call([{methodname:"core_form_dynamic_form",args:{formdata:c,form:this.config.formClass}}])[0].then(function(a){if(!a.submitted){var c=new Promise(function(b){return b({html:a.html,js:h.default.processCollectedJavascript(a.javascript)})});b.modal.setBodyContent(c);b.enableButtons();b.trigger(b.events.SERVER_VALIDATION_ERROR)}else{var d=JSON.parse(a.data);return b.notifyResetFormChanges().then(function(){var a=b.trigger(b.events.FORM_SUBMITTED,d);if(!a.defaultPrevented){b.modal.hide()}return null})}return null}).catch(this.onSubmitError);case 8:case"end":return a.stop();}}},a,this)}));return function submitFormAjax(){return a.apply(this,arguments)}}()},{key:"setSaveButtonClasses",value:function setSaveButtonClasses(a){var b=this.modal.getFooter().find("[data-action='save']");if(!b){throw new Error("Unable to find the 'save' button")}b.removeClass().addClass(a)}}]);return a}();a.default=y;return a.default});
//# sourceMappingURL=modalform.min.js.map
