define ("core_backup/async_backup",["jquery","core/ajax","core/str","core/notification","core/templates"],function(a,b,c,d,e){var n=900,o=1e3,p={},q=15e3,r=15e3,s=1.5,t,u,v,w,x,y,z=2e3;function f(b,c){var d=Math.round(c)+"%",e=a("#"+b+"_bar"),f=c.toFixed(2)+"%";e.attr("aria-valuenow",d);e.css("width",d);e.text(f)}function g(a,b,c){clearInterval(a);return setInterval(b,c)}function h(c){var f=a("#"+c+"_bar").parent().parent(),g=f.parent(),h=f.siblings(),i=h[1],j=a(i).text(),k=h[0],l=a(k).text();b.call([{methodname:"core_backup_get_async_backup_links_backup",args:{filename:l,contextid:u}}])[0].done(function(a){var b={filename:l,time:j,size:a.filesize,fileurl:a.fileurl,restoreurl:a.restoreurl};e.render("core/async_backup_progress_row",b).then(function(a,b){e.replaceNodeContents(g,a,b)}).fail(function(){d.exception(new Error("Failed to load table row"))})})}function i(c){var f=a("#"+c+"_bar").parent().parent(),g=f.parent(),h=f.siblings(),i=h[0],j=h[1],k=a(j).text();b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:c,contextid:u}}])[0].done(function(b){var c=a(i).text(),f={resourcename:c,restoreurl:b.restoreurl,time:k};e.render("core/async_restore_progress_row",f).then(function(a,b){e.replaceNodeContents(g,a,b)}).fail(function(){d.exception(new Error("Failed to load table row"))})})}function j(e){var g=100*e.progress,h=a("#"+t+"_bar"),i=a("#"+t+"_status"),j=a("#"+t+"_detail"),k=a("#"+t+"_button"),l;if(e.status==800){h.addClass("bg-success");f(t,g);var m="async"+w+"processing";c.get_string(m,"backup").then(function(a){i.text(a);return a}).catch(function(){d.exception(new Error("Failed to load string: backup "+m))})}else if(e.status==n){h.addClass("bg-danger");h.removeClass("bg-success");f(t,100);var p="async"+w+"error",q="async"+w+"errordetail";l=[{key:p,component:"backup"},{key:q,component:"backup"}];c.get_strings(l).then(function(a){i.text(a[0]);j.text(a[1]);return a}).catch(function(){d.exception(new Error("Failed to load string"))});a(".backup_progress").children("span").removeClass("backup_stage_current");a(".backup_progress").children("span").last().addClass("backup_stage_current");clearInterval(x)}else if(e.status==o){h.addClass("bg-success");f(t,100);var r="async"+w+"complete";c.get_string(r,"backup").then(function(a){i.text(a);return a}).catch(function(){d.exception(new Error("Failed to load string: backup "+r))});if("restore"==w){b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:t,contextid:u}}])[0].done(function(a){var b="async"+w+"completedetail",e="async"+w+"completebutton",f=[{key:b,component:"backup",param:a.restoreurl},{key:e,component:"backup"}];c.get_strings(f).then(function(b){j.html(b[0]);k.text(b[1]);k.attr("href",a.restoreurl);return b}).catch(function(){d.exception(new Error("Failed to load string"))})})}else{var s="async"+w+"completedetail",y="async"+w+"completebutton";l=[{key:s,component:"backup",param:v},{key:y,component:"backup"}];c.get_strings(l).then(function(a){j.html(a[0]);k.text(a[1]);k.attr("href",v);return a}).catch(function(){d.exception(new Error("Failed to load string"))})}a(".backup_progress").children("span").removeClass("backup_stage_current");a(".backup_progress").children("span").last().addClass("backup_stage_current");clearInterval(x)}}function k(b){b.forEach(function(b){var c=100*b.progress,d=b.backupid,e=a("#"+d+"_bar"),g=b.operation;if(b.status==800){e.addClass("bg-success");f(d,c)}else if(b.status==n){e.addClass("bg-danger");e.addClass("complete");a("#"+d+"_bar").removeClass("bg-success");f(d,100)}else if(b.status==o){e.addClass("bg-success");e.addClass("complete");f(d,100);if("backup"==g){h(d)}else{i(d)}}})}function l(){b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:[t],contextid:u}}],!0,!0,!1,z)[0].done(function(a){j(a[0]);r=q;x=g(x,l,q)}).fail(function(){r=r*s;x=g(x,l,r)})}function m(){var c=[],d=a(".progress").find(".progress-bar").not(".complete");d.each(function(){c.push(this.id.substring(0,32))});if(0<c.length){b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:c,contextid:u}}],!0,!0,!1,z)[0].done(function(a){k(a);r=q;y=g(y,m,q)}).fail(function(){r=r*s;y=g(y,m,r)})}else{clearInterval(y)}}p.asyncBackupAllStatus=function(a){u=a;y=setInterval(m,r)};p.asyncBackupStatus=function(b,c,d,e){t=b;u=c;v=d;if("backup"==e){w="backup"}else{w="restore"}a(".backup_progress").children("a").removeAttr("href");x=setInterval(l,r)};return p});
//# sourceMappingURL=async_backup.min.js.map
