{"version":3,"sources":["../src/form.js"],"names":["confirmDelete","id","type","component","area","itemid","pendingPromise","Pending","then","strings","Notification","confirm","pendingDeletePromise","methodname","args","response","Templates","render","html","js","replaceNode","resolve","catch","exception","createNewCategory","promises","createNewField","element","returnFocus","closest","querySelector","form","ModalForm","formClass","categoryid","getAttribute","modalConfig","title","addEventListener","events","FORM_SUBMITTED","pendingCreatedPromise","window","location","reload","show","editField","getCategoryNameFor","nodeElement","find","attr","setupSortableLists","rootNode","sortCat","SortableList","moveHandlerSelector","getElementName","Promise","on","EVENTS","DROP","evt","info","positionChanged","data","beforeid","targetNextElement","stopPropagation","sort","getDestinationName","parentElement","afterElement","length","targetList","DRAG","querySelectorAll","forEach","category","fields","noFields","innerHTML","remove","DRAGSTART","setTimeout","width","init","document","dataset","e","roleHolder","target","role","preventDefault"],"mappings":"6SA6BA,OACA,OACA,OACA,OACA,OACA,O,sDAWMA,CAAAA,CAAa,CAAG,SAACC,CAAD,CAAKC,CAAL,CAAWC,CAAX,CAAsBC,CAAtB,CAA4BC,CAA5B,CAAuC,CACzD,GAAMC,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,qCAAZ,CAAvB,CAEA,kBAAW,CACP,CAAC,IAAO,SAAR,CADO,CAEP,CAAC,IAAO,gBAAkBL,CAA1B,CAAgCC,SAAS,CAAE,kBAA3C,CAFO,CAGP,CAAC,IAAO,KAAR,CAHO,CAIP,CAAC,IAAO,IAAR,CAJO,CAAX,EAMCK,IAND,CAMM,SAAAC,CAAO,CAAI,CACb,MAAOC,WAAaC,OAAb,CAAqBF,CAAO,CAAC,CAAD,CAA5B,CAAiCA,CAAO,CAAC,CAAD,CAAxC,CAA6CA,CAAO,CAAC,CAAD,CAApD,CAAyDA,CAAO,CAAC,CAAD,CAAhE,CAAqE,UAAW,CACnF,GAAMG,CAAAA,CAAoB,CAAG,GAAIL,UAAJ,CAAY,qCAAZ,CAA7B,CACA,WAAU,CACN,CACIM,UAAU,CAAY,OAAT,GAAAX,CAAD,CAAqB,+BAArB,CAAuD,kCADvE,CAEIY,IAAI,CAAE,CAACb,EAAE,CAAFA,CAAD,CAFV,CADM,CAKN,CAACY,UAAU,CAAE,kCAAb,CAAiDC,IAAI,CAAE,CAACX,SAAS,CAATA,CAAD,CAAYC,IAAI,CAAJA,CAAZ,CAAkBC,MAAM,CAANA,CAAlB,CAAvD,CALM,CAAV,EAMG,CANH,EAOCG,IAPD,CAOM,SAAAO,CAAQ,QAAIC,WAAUC,MAAV,CAAiB,uBAAjB,CAA0CF,CAA1C,CAAJ,CAPd,EAQCP,IARD,CAQM,SAACU,CAAD,CAAOC,CAAP,QAAcH,WAAUI,WAAV,CAAsB,cAAO,6BAAP,CAAtB,CAA2DF,CAA3D,CAAiEC,CAAjE,CAAd,CARN,EASCX,IATD,CASMI,CAAoB,CAACS,OAT3B,EAUCC,KAVD,CAUOZ,UAAaa,SAVpB,CAWH,CAbM,CAcV,CArBD,EAsBCf,IAtBD,CAsBMF,CAAc,CAACe,OAtBrB,EAuBCC,KAvBD,CAuBOZ,UAAaa,SAvBpB,CAwBH,C,CAUKC,CAAiB,CAAG,SAACrB,CAAD,CAAYC,CAAZ,CAAkBC,CAAlB,CAA6B,IAC7CC,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,yCAAZ,CAD4B,CAE7CkB,CAAQ,CAAG,WAAU,CACvB,CAACZ,UAAU,CAAE,kCAAb,CAAiDC,IAAI,CAAE,CAACX,SAAS,CAATA,CAAD,CAAYC,IAAI,CAAJA,CAAZ,CAAkBC,MAAM,CAANA,CAAlB,CAAvD,CADuB,CAEvB,CAACQ,UAAU,CAAE,kCAAb,CAAiDC,IAAI,CAAE,CAACX,SAAS,CAATA,CAAD,CAAYC,IAAI,CAAJA,CAAZ,CAAkBC,MAAM,CAANA,CAAlB,CAAvD,CAFuB,CAAV,CAFkC,CAOnDoB,CAAQ,CAAC,CAAD,CAAR,CAAYjB,IAAZ,CAAiB,SAAAO,CAAQ,QAAIC,WAAUC,MAAV,CAAiB,uBAAjB,CAA0CF,CAA1C,CAAJ,CAAzB,EACCP,IADD,CACM,SAACU,CAAD,CAAOC,CAAP,QAAcH,WAAUI,WAAV,CAAsB,cAAO,6BAAP,CAAtB,CAA2DF,CAA3D,CAAiEC,CAAjE,CAAd,CADN,EAECX,IAFD,CAEM,iBAAMF,CAAAA,CAAc,CAACe,OAAf,EAAN,CAFN,EAGCC,KAHD,CAGOZ,UAAaa,SAHpB,CAIH,C,CAUKG,CAAc,CAAG,SAACC,CAAD,CAAUxB,CAAV,CAAqBC,CAArB,CAA2BC,CAA3B,CAAsC,IACnDC,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,sCAAZ,CADkC,CAGnDqB,CAAW,CAAGD,CAAO,CAACE,OAAR,CAAgB,cAAhB,EAAgCC,aAAhC,CAA8C,kBAA9C,CAHqC,CAInDC,CAAI,CAAG,GAAIC,UAAJ,CAAc,CACvBC,SAAS,CAAE,qCADY,CAEvBnB,IAAI,CAAE,CACFoB,UAAU,CAAEP,CAAO,CAACQ,YAAR,CAAqB,iBAArB,CADV,CAEFjC,IAAI,CAAEyB,CAAO,CAACQ,YAAR,CAAqB,WAArB,CAFJ,CAFiB,CAMvBC,WAAW,CAAE,CACTC,KAAK,CAAE,iBAAU,sBAAV,CAAkC,kBAAlC,CAAsDV,CAAO,CAACQ,YAAR,CAAqB,eAArB,CAAtD,CADE,CANU,CASvBP,WAAW,CAAXA,CATuB,CAAd,CAJ4C,CAgBzDG,CAAI,CAACO,gBAAL,CAAsBP,CAAI,CAACQ,MAAL,CAAYC,cAAlC,CAAkD,UAAM,IAC9CC,CAAAA,CAAqB,CAAG,GAAIlC,UAAJ,CAAY,uCAAZ,CADsB,CAE9CkB,CAAQ,CAAG,WAAU,CACvB,CAACZ,UAAU,CAAE,kCAAb,CAAiDC,IAAI,CAAE,CAACX,SAAS,CAAEA,CAAZ,CAAuBC,IAAI,CAAEA,CAA7B,CAAmCC,MAAM,CAAEA,CAA3C,CAAvD,CADuB,CAAV,CAFmC,CAMpDoB,CAAQ,CAAC,CAAD,CAAR,CAAYjB,IAAZ,CAAiB,SAAAO,CAAQ,QAAIC,WAAUC,MAAV,CAAiB,uBAAjB,CAA0CF,CAA1C,CAAJ,CAAzB,EACCP,IADD,CACM,SAACU,CAAD,CAAOC,CAAP,QAAcH,WAAUI,WAAV,CAAsB,cAAO,6BAAP,CAAtB,CAA2DF,CAA3D,CAAiEC,CAAjE,CAAd,CADN,EAECX,IAFD,CAEM,iBAAMiC,CAAAA,CAAqB,CAACpB,OAAtB,EAAN,CAFN,EAGCC,KAHD,CAGO,iBAAMoB,CAAAA,MAAM,CAACC,QAAP,CAAgBC,MAAhB,EAAN,CAHP,CAIH,CAVD,EAYAb,CAAI,CAACc,IAAL,GAEAvC,CAAc,CAACe,OAAf,EACH,C,CAUKyB,CAAS,CAAG,SAACnB,CAAD,CAAUxB,CAAV,CAAqBC,CAArB,CAA2BC,CAA3B,CAAsC,IAC9CC,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,iCAAZ,CAD6B,CAG9CwB,CAAI,CAAG,GAAIC,UAAJ,CAAc,CACvBC,SAAS,CAAE,qCADY,CAEvBnB,IAAI,CAAE,CACFb,EAAE,CAAE0B,CAAO,CAACQ,YAAR,CAAqB,SAArB,CADF,CAFiB,CAKvBC,WAAW,CAAE,CACTC,KAAK,CAAE,iBAAU,cAAV,CAA0B,kBAA1B,CAA8CV,CAAO,CAACQ,YAAR,CAAqB,WAArB,CAA9C,CADE,CALU,CAQvBP,WAAW,CAAED,CARU,CAAd,CAHuC,CAcpDI,CAAI,CAACO,gBAAL,CAAsBP,CAAI,CAACQ,MAAL,CAAYC,cAAlC,CAAkD,UAAM,IAC9CC,CAAAA,CAAqB,CAAG,GAAIlC,UAAJ,CAAY,uCAAZ,CADsB,CAE9CkB,CAAQ,CAAG,WAAU,CACvB,CAACZ,UAAU,CAAE,kCAAb,CAAiDC,IAAI,CAAE,CAACX,SAAS,CAAEA,CAAZ,CAAuBC,IAAI,CAAEA,CAA7B,CAAmCC,MAAM,CAAEA,CAA3C,CAAvD,CADuB,CAAV,CAFmC,CAMpDoB,CAAQ,CAAC,CAAD,CAAR,CAAYjB,IAAZ,CAAiB,SAAAO,CAAQ,QAAIC,WAAUC,MAAV,CAAiB,uBAAjB,CAA0CF,CAA1C,CAAJ,CAAzB,EACCP,IADD,CACM,SAACU,CAAD,CAAOC,CAAP,QAAcH,WAAUI,WAAV,CAAsB,cAAO,6BAAP,CAAtB,CAA2DF,CAA3D,CAAiEC,CAAjE,CAAd,CADN,EAECX,IAFD,CAEM,iBAAMiC,CAAAA,CAAqB,CAACpB,OAAtB,EAAN,CAFN,EAGCC,KAHD,CAGO,iBAAMoB,CAAAA,MAAM,CAACC,QAAP,CAAgBC,MAAhB,EAAN,CAHP,CAIH,CAVD,EAYAb,CAAI,CAACc,IAAL,GAEAvC,CAAc,CAACe,OAAf,EACH,C,CAQK0B,CAAkB,CAAG,SAAAC,CAAW,QAAIA,CAAAA,CAAW,CAChDnB,OADqC,CAC7B,oBAD6B,EAErCoB,IAFqC,CAEhC,iFAFgC,EAGrCC,IAHqC,CAGhC,YAHgC,CAAJ,C,CAKhCC,CAAkB,CAAG,SAAAC,CAAQ,CAAI,CAEnC,GAAMC,CAAAA,CAAO,CAAG,GAAIC,UAAJ,CACZ,sCADY,CAEZ,CACIC,mBAAmB,CAAE,qCADzB,CAFY,CAAhB,CAMAF,CAAO,CAACG,cAAR,CAAyB,SAAAR,CAAW,QAAIS,CAAAA,OAAO,CAACpC,OAAR,CAAgB0B,CAAkB,CAACC,CAAD,CAAlC,CAAJ,CAApC,CAGA,cAAO,oBAAP,EAA6BU,EAA7B,CAAgCJ,UAAaK,MAAb,CAAoBC,IAApD,CAA0D,SAACC,CAAD,CAAMC,CAAN,CAAe,CACrE,GAAIA,CAAI,CAACC,eAAT,CAA0B,CACtB,GAAMzD,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,uDAAZ,CAAvB,CACA,WAAU,CAAC,CACPM,UAAU,CAAE,gCADL,CAEPC,IAAI,CAAE,CACFb,EAAE,CAAE6D,CAAI,CAACnC,OAAL,CAAaqC,IAAb,CAAkB,aAAlB,CADF,CAEFC,QAAQ,CAAEH,CAAI,CAACI,iBAAL,CAAuBF,IAAvB,CAA4B,aAA5B,CAFR,CAFC,CAAD,CAAV,EAOI,CAPJ,EAQCxD,IARD,CAQMF,CAAc,CAACe,OARrB,EASCC,KATD,CASOZ,UAAaa,SATpB,CAUH,CACDsC,CAAG,CAACM,eAAJ,EACH,CAfD,EAkBA,GAAIC,CAAAA,CAAI,CAAG,GAAId,UAAJ,CACP,wCADO,CAEP,CACIC,mBAAmB,CAAE,kCADzB,CAFO,CAAX,CAOAa,CAAI,CAACC,kBAAL,CAA0B,SAACC,CAAD,CAAgBC,CAAhB,CAAiC,CACvD,GAAI,CAACA,CAAY,CAACC,MAAlB,CAA0B,CACtB,MAAO,iBAAU,iBAAV,CAA6B,aAA7B,CAA4CzB,CAAkB,CAACuB,CAAD,CAA9D,CACV,CAFD,IAEO,IAAIC,CAAY,CAACrB,IAAb,CAAkB,iBAAlB,CAAJ,CAA0C,CAC7C,MAAO,iBAAU,YAAV,CAAwB,aAAxB,CAAuCqB,CAAY,CAACrB,IAAb,CAAkB,iBAAlB,CAAvC,CACV,CAFM,IAEA,CACH,MAAOO,CAAAA,OAAO,CAACpC,OAAR,CAAgB,EAAhB,CACV,CACJ,CARD,CAUA,cAAO,mBAAP,EAA4BqC,EAA5B,CAA+BJ,UAAaK,MAAb,CAAoBC,IAAnD,CAAyD,SAACC,CAAD,CAAMC,CAAN,CAAe,CACpE,GAAIA,CAAI,CAACC,eAAT,CAA0B,CACtB,GAAMzD,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,sDAAZ,CAAvB,CACA,WAAU,CAAC,CACPM,UAAU,CAAE,6BADL,CAEPC,IAAI,CAAE,CACFb,EAAE,CAAE6D,CAAI,CAACnC,OAAL,CAAaqC,IAAb,CAAkB,UAAlB,CADF,CAEFC,QAAQ,CAAEH,CAAI,CAACI,iBAAL,CAAuBF,IAAvB,CAA4B,UAA5B,CAFR,CAGF9B,UAAU,EAAS4B,CAAI,CAACW,UAAL,CAAgB5C,OAAhB,CAAwB,oBAAxB,EAA8CqB,IAA9C,CAAmD,kBAAnD,CAHjB,CAFC,CAAD,CAAV,EAOI,CAPJ,EAQC1C,IARD,CAQMF,CAAc,CAACe,OARrB,EASCC,KATD,CASOZ,UAAaa,SATpB,CAUH,CACDsC,CAAG,CAACM,eAAJ,EACH,CAfD,EAiBA,cAAO,mBAAP,EAA4BT,EAA5B,CAA+BJ,UAAaK,MAAb,CAAoBe,IAAnD,CAAyD,SAAAb,CAAG,CAAI,CAC5D,GAAIvD,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAY,sDAAZ,CAArB,CAEAsD,CAAG,CAACM,eAAJ,GAGAnD,UAAUC,MAAV,CAAiB,2BAAjB,CAA8C,EAA9C,EACCT,IADD,CACM,SAAAU,CAAI,CAAI,CACVkC,CAAQ,CAACuB,gBAAT,CAA0B,qBAA1B,EACCC,OADD,CACS,SAAAC,CAAQ,CAAI,IACXC,CAAAA,CAAM,CAAGD,CAAQ,CAACF,gBAAT,CAA0B,uCAA1B,CADE,CAEXI,CAAQ,CAAGF,CAAQ,CAAC/C,aAAT,CAAuB,WAAvB,CAFA,CAIjB,GAAI,CAACgD,CAAM,CAACN,MAAR,EAAkB,CAACO,CAAvB,CAAiC,CAC7BF,CAAQ,CAAC/C,aAAT,CAAuB,OAAvB,EAAgCkD,SAAhC,CAA4C9D,CAC/C,CAFD,IAEO,IAAI4D,CAAM,CAACN,MAAP,EAAiBO,CAArB,CAA+B,CAClCA,CAAQ,CAACE,MAAT,EACH,CACJ,CAVD,CAYH,CAdD,EAeCzE,IAfD,CAeMF,CAAc,CAACe,OAfrB,EAgBCC,KAhBD,CAgBOZ,UAAaa,SAhBpB,CAiBH,CAvBD,EAyBA,cAAO,uCAAP,EAAgDmC,EAAhD,CAAmDJ,UAAaK,MAAb,CAAoBuB,SAAvE,CAAkF,SAACrB,CAAD,CAAMC,CAAN,CAAe,CAC7FqB,UAAU,CAAC,UAAM,CACb,cAAO,2BAAP,EAAoCC,KAApC,CAA0CtB,CAAI,CAACnC,OAAL,CAAayD,KAAb,EAA1C,CACH,CAFS,CAEP,GAFO,CAGb,CAJD,CAKH,C,QAKmB,QAAPC,CAAAA,IAAO,EAAM,IAChBjC,CAAAA,CAAQ,CAAGkC,QAAQ,CAACxD,aAAT,CAAuB,sBAAvB,CADK,CAGhB3B,CAAS,CAAGiD,CAAQ,CAACmC,OAAT,CAAiBpF,SAHb,CAIhBC,CAAI,CAAGgD,CAAQ,CAACmC,OAAT,CAAiBnF,IAJR,CAKhBC,CAAM,CAAG+C,CAAQ,CAACmC,OAAT,CAAiBlF,MALV,CAOtB+C,CAAQ,CAACd,gBAAT,CAA0B,OAA1B,CAAmC,SAAAkD,CAAC,CAAI,CACpC,GAAMC,CAAAA,CAAU,CAAGD,CAAC,CAACE,MAAF,CAAS7D,OAAT,CAAiB,aAAjB,CAAnB,CACA,GAAI,CAAC4D,CAAL,CAAiB,CACb,MACH,CAED,GAAgC,aAA5B,GAAAA,CAAU,CAACF,OAAX,CAAmBI,IAAvB,CAA+C,CAC3CH,CAAC,CAACI,cAAF,GAEA5F,CAAa,CAACyF,CAAU,CAACF,OAAX,CAAmBtF,EAApB,CAAwB,OAAxB,CAAiCE,CAAjC,CAA4CC,CAA5C,CAAkDC,CAAlD,CAAb,CACA,MACH,CAED,GAAgC,gBAA5B,GAAAoF,CAAU,CAACF,OAAX,CAAmBI,IAAvB,CAAkD,CAC9CH,CAAC,CAACI,cAAF,GAEA5F,CAAa,CAACyF,CAAU,CAACF,OAAX,CAAmBtF,EAApB,CAAwB,UAAxB,CAAoCE,CAApC,CAA+CC,CAA/C,CAAqDC,CAArD,CAAb,CACA,MACH,CAED,GAAgC,gBAA5B,GAAAoF,CAAU,CAACF,OAAX,CAAmBI,IAAvB,CAAkD,CAC9CH,CAAC,CAACI,cAAF,GACApE,CAAiB,CAACrB,CAAD,CAAYC,CAAZ,CAAkBC,CAAlB,CAAjB,CAEA,MACH,CAED,GAAgC,UAA5B,GAAAoF,CAAU,CAACF,OAAX,CAAmBI,IAAvB,CAA4C,CACxCH,CAAC,CAACI,cAAF,GACAlE,CAAc,CAAC+D,CAAD,CAAatF,CAAb,CAAwBC,CAAxB,CAA8BC,CAA9B,CAAd,CAEA,MACH,CAED,GAAgC,WAA5B,GAAAoF,CAAU,CAACF,OAAX,CAAmBI,IAAvB,CAA6C,CACzCH,CAAC,CAACI,cAAF,GACA9C,CAAS,CAAC2C,CAAD,CAAatF,CAAb,CAAwBC,CAAxB,CAA8BC,CAA9B,CAGZ,CACJ,CAxCD,EA0CA8C,CAAkB,CAACC,CAAD,CAAWjD,CAAX,CAAsBC,CAAtB,CAA4BC,CAA5B,CACrB,C","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Custom Field interaction management for Moodle.\n *\n * @module     core_customfield/form\n * @copyright  2018 Toni Barbera\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport 'core/inplace_editable';\nimport {call as fetchMany} from 'core/ajax';\nimport {\n    get_string as getString,\n    get_strings as getStrings,\n} from 'core/str';\nimport ModalForm from 'core_form/modalform';\nimport Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport SortableList from 'core/sortable_list';\nimport Templates from 'core/templates';\nimport jQuery from 'jquery';\n\n/**\n * Display confirmation dialogue\n *\n * @param {Number} id\n * @param {String} type\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst confirmDelete = (id, type, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:confirmDelete');\n\n    getStrings([\n        {'key': 'confirm'},\n        {'key': 'confirmdelete' + type, component: 'core_customfield'},\n        {'key': 'yes'},\n        {'key': 'no'},\n    ])\n    .then(strings => {\n        return Notification.confirm(strings[0], strings[1], strings[2], strings[3], function() {\n            const pendingDeletePromise = new Pending('core_customfield/form:confirmDelete');\n            fetchMany([\n                {\n                    methodname: (type === 'field') ? 'core_customfield_delete_field' : 'core_customfield_delete_category',\n                    args: {id},\n                },\n                {methodname: 'core_customfield_reload_template', args: {component, area, itemid}}\n            ])[1]\n            .then(response => Templates.render('core_customfield/list', response))\n            .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n            .then(pendingDeletePromise.resolve)\n            .catch(Notification.exception);\n        });\n    })\n    .then(pendingPromise.resolve)\n    .catch(Notification.exception);\n};\n\n\n/**\n * Creates a new custom fields category with default name and updates the list\n *\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst createNewCategory = (component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:createNewCategory');\n    const promises = fetchMany([\n        {methodname: 'core_customfield_create_category', args: {component, area, itemid}},\n        {methodname: 'core_customfield_reload_template', args: {component, area, itemid}}\n    ]);\n\n    promises[1].then(response => Templates.render('core_customfield/list', response))\n    .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n    .then(() => pendingPromise.resolve())\n    .catch(Notification.exception);\n};\n\n/**\n * Create new custom field\n *\n * @param {HTMLElement} element\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst createNewField = (element, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:createNewField');\n\n    const returnFocus = element.closest(\".action-menu\").querySelector(\".dropdown-toggle\");\n    const form = new ModalForm({\n        formClass: \"core_customfield\\\\field_config_form\",\n        args: {\n            categoryid: element.getAttribute('data-categoryid'),\n            type: element.getAttribute('data-type'),\n        },\n        modalConfig: {\n            title: getString('addingnewcustomfield', 'core_customfield', element.getAttribute('data-typename')),\n        },\n        returnFocus,\n    });\n\n    form.addEventListener(form.events.FORM_SUBMITTED, () => {\n        const pendingCreatedPromise = new Pending('core_customfield/form:createdNewField');\n        const promises = fetchMany([\n            {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n        ]);\n\n        promises[0].then(response => Templates.render('core_customfield/list', response))\n        .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n        .then(() => pendingCreatedPromise.resolve())\n        .catch(() => window.location.reload());\n    });\n\n    form.show();\n\n    pendingPromise.resolve();\n};\n\n/**\n * Edit custom field\n *\n * @param {HTMLElement} element\n * @param {String} component\n * @param {String} area\n * @param {Number} itemid\n */\nconst editField = (element, component, area, itemid) => {\n    const pendingPromise = new Pending('core_customfield/form:editField');\n\n    const form = new ModalForm({\n        formClass: \"core_customfield\\\\field_config_form\",\n        args: {\n            id: element.getAttribute('data-id'),\n        },\n        modalConfig: {\n            title: getString('editingfield', 'core_customfield', element.getAttribute('data-name')),\n        },\n        returnFocus: element,\n    });\n\n    form.addEventListener(form.events.FORM_SUBMITTED, () => {\n        const pendingCreatedPromise = new Pending('core_customfield/form:createdNewField');\n        const promises = fetchMany([\n            {methodname: 'core_customfield_reload_template', args: {component: component, area: area, itemid: itemid}}\n        ]);\n\n        promises[0].then(response => Templates.render('core_customfield/list', response))\n        .then((html, js) => Templates.replaceNode(jQuery('[data-region=\"list-page\"]'), html, js))\n        .then(() => pendingCreatedPromise.resolve())\n        .catch(() => window.location.reload());\n    });\n\n    form.show();\n\n    pendingPromise.resolve();\n};\n\n/**\n * Fetch the category name from an inplace editable, given a child node of that field.\n *\n * @param {NodeElement} nodeElement\n * @returns {String}\n */\nconst getCategoryNameFor = nodeElement => nodeElement\n    .closest('[data-category-id]')\n    .find('[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]')\n    .attr('data-value');\n\nconst setupSortableLists = rootNode => {\n    // Sort category.\n    const sortCat = new SortableList(\n        '#customfield_catlist .categorieslist',\n        {\n            moveHandlerSelector: '.movecategory [data-drag-type=move]',\n        }\n    );\n    sortCat.getElementName = nodeElement => Promise.resolve(getCategoryNameFor(nodeElement));\n\n    // Note: The sortable list currently uses jQuery events.\n    jQuery('[data-category-id]').on(SortableList.EVENTS.DROP, (evt, info) => {\n        if (info.positionChanged) {\n            const pendingPromise = new Pending('core_customfield/form:categoryid:on:sortablelist-drop');\n            fetchMany([{\n                methodname: 'core_customfield_move_category',\n                args: {\n                    id: info.element.data('category-id'),\n                    beforeid: info.targetNextElement.data('category-id')\n                }\n\n            }])[0]\n            .then(pendingPromise.resolve)\n            .catch(Notification.exception);\n        }\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n    });\n\n    // Sort fields.\n    var sort = new SortableList(\n        '#customfield_catlist .fieldslist tbody',\n        {\n            moveHandlerSelector: '.movefield [data-drag-type=move]',\n        }\n    );\n\n    sort.getDestinationName = (parentElement, afterElement) => {\n        if (!afterElement.length) {\n            return getString('totopofcategory', 'customfield', getCategoryNameFor(parentElement));\n        } else if (afterElement.attr('data-field-name')) {\n            return getString('afterfield', 'customfield', afterElement.attr('data-field-name'));\n        } else {\n            return Promise.resolve('');\n        }\n    };\n\n    jQuery('[data-field-name]').on(SortableList.EVENTS.DROP, (evt, info) => {\n        if (info.positionChanged) {\n            const pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drop');\n            fetchMany([{\n                methodname: 'core_customfield_move_field',\n                args: {\n                    id: info.element.data('field-id'),\n                    beforeid: info.targetNextElement.data('field-id'),\n                    categoryid: Number(info.targetList.closest('[data-category-id]').attr('data-category-id'))\n                },\n            }])[0]\n            .then(pendingPromise.resolve)\n            .catch(Notification.exception);\n        }\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n    });\n\n    jQuery('[data-field-name]').on(SortableList.EVENTS.DRAG, evt => {\n        var pendingPromise = new Pending('core_customfield/form:fieldname:on:sortablelist-drag');\n\n        evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n\n        // Refreshing fields tables.\n        Templates.render('core_customfield/nofields', {})\n        .then(html => {\n            rootNode.querySelectorAll('.categorieslist > *')\n            .forEach(category => {\n                const fields = category.querySelectorAll('.field:not(.sortable-list-is-dragged)');\n                const noFields = category.querySelector('.nofields');\n\n                if (!fields.length && !noFields) {\n                    category.querySelector('tbody').innerHTML = html;\n                } else if (fields.length && noFields) {\n                    noFields.remove();\n                }\n            });\n            return;\n        })\n        .then(pendingPromise.resolve)\n        .catch(Notification.exception);\n    });\n\n    jQuery('[data-category-id], [data-field-name]').on(SortableList.EVENTS.DRAGSTART, (evt, info) => {\n        setTimeout(() => {\n            jQuery('.sortable-list-is-dragged').width(info.element.width());\n        }, 501);\n    });\n};\n\n/**\n * Initialise the custom fields manager.\n */\nexport const init = () => {\n    const rootNode = document.querySelector('#customfield_catlist');\n\n    const component = rootNode.dataset.component;\n    const area = rootNode.dataset.area;\n    const itemid = rootNode.dataset.itemid;\n\n    rootNode.addEventListener('click', e => {\n        const roleHolder = e.target.closest('[data-role]');\n        if (!roleHolder) {\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'deletefield') {\n            e.preventDefault();\n\n            confirmDelete(roleHolder.dataset.id, 'field', component, area, itemid);\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'deletecategory') {\n            e.preventDefault();\n\n            confirmDelete(roleHolder.dataset.id, 'category', component, area, itemid);\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'addnewcategory') {\n            e.preventDefault();\n            createNewCategory(component, area, itemid);\n\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'addfield') {\n            e.preventDefault();\n            createNewField(roleHolder, component, area, itemid);\n\n            return;\n        }\n\n        if (roleHolder.dataset.role === 'editfield') {\n            e.preventDefault();\n            editField(roleHolder, component, area, itemid);\n\n            return;\n        }\n    });\n\n    setupSortableLists(rootNode, component, area, itemid);\n};\n"],"file":"form.min.js"}