{"version":3,"file":"course_mod_modal.min.js","sources":["../src/course_mod_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/* eslint space-before-function-paren: 0 */\n\n/**\n * Javascript Module to handle rendering of course modules (e.g. resource/PDF, resource/html, page) in modal windows\n *\n * When the user clicks a PDF course module subtile or old style resource\n * if we are using modals for it (e.g. PDF) , create, populate, launch and size the modal\n *\n * @module      format_tiles/course_mod_modal\n * @copyright   2018 David Watson {@link http://evolutioncode.uk}\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since       Moodle 3.3\n */\n\ndefine([\"jquery\", \"core/modal_factory\", \"core/config\", \"core/templates\", \"core/notification\", \"core/ajax\",\n        'core/fragment', \"core/modal_events\"],\n    function ($, modalFactory, config, Templates, Notification, ajax, Fragment, ModalEvents) {\n        \"use strict\";\n\n        var loadingIconHtml;\n        const win = $(window);\n        var courseId;\n        var tilesConfig;\n        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n\n        const Selector = {\n            modal: \".modal\",\n            modalDialog: \".modal-dialog\",\n            modalBody: \".modal-body\",\n            sectionMain: \".section.main\",\n            pageContent: \"#page-content\",\n            regionMain: \"#region-main\",\n            completionState: \"#completion-check-\",\n            cmModal: \".embed_cm_modal\",\n            moodleMediaPlayer: \".mediaplugin_videojs\",\n            closeBtn: \"button.close\",\n            ACTIVITY: \"li.activity\",\n            URLACTIVITYPOPUPLINK: \".activity.modtype_url.urlpopup a\",\n            modalHeader: \".modal-header\",\n            embedModuleButtons: \".embed-module-buttons\",\n            iframe: \"iframe\"\n        };\n\n        const CLASS = {\n            COMPLETION_ENABLED: \"completion-enabled\",\n            COMPLETION_MANUAL: \"completion-manual\",\n            COMPLETION_AUTO: \"completion-auto\", // E.g. grade based.\n            COMPLETION_VIEW: \"completion-view\",\n            COMPLETION_CHECK_BOX: \"completioncheckbox\",\n            COMPLETION_DROPDOWN: \"completion-dropdown\"\n        };\n\n        const modalMinWidth = function () {\n            return Math.min(win.width(), 1100);\n        };\n\n        /**\n         * Some modals contain videos in iframes or objects, which need to stop playing when dismissed.\n         * @param {object} modal the modal which contains the video.\n         */\n        const stopAllVideosOnDismiss = function(modal) {\n            modal.on(ModalEvents.hidden, function() {\n                const iframes = modal.find(Selector.iframe);\n                const objects = modal.find(\"object\");\n                const moodleMediaPlayer = modal.find(Selector.moodleMediaPlayer);\n\n                if (iframes.length || objects.length || moodleMediaPlayer.length) {\n                    modal.remove();\n                }\n            });\n        };\n        /**\n         *\n         * @param {number} cmId\n         * @param {number} moduleContextId\n         * @param {number} sectionNum\n         * @param {string} title\n         * @param {string} objectType\n         * @param {boolean} completionEnabled\n         * @param {number} existingCompletionState\n         * @param {boolean} isManualCompletion\n         * @param {string} descriptionHTML\n         * @returns {boolean}\n         */\n        const launchCmModal = function (\n                cmId, moduleContextId, sectionNum, title, objectType,\n                completionEnabled, existingCompletionState, isManualCompletion, descriptionHTML\n            ) {\n            modalFactory.create({\n                type: modalFactory.types.DEFAULT,\n                title: title,\n                body: loadingIconHtml\n            }).done(function (modal) {\n                modal.setLarge();\n                modal.show();\n                modal.setScrollable(false);\n                const modalRoot = $(modal.root);\n                const modalId = \"embed_mod_modal_\" + cmId;\n                // If modal exists from previous launch, remove.\n                $(`#${modalId}`).remove();\n                modalRoot.attr(\"id\", modalId);\n                modalRoot.data(\"cmid\", cmId);\n                modalRoot.data(\"section\", sectionNum);\n                modalRoot.addClass(\"embed_cm_modal\");\n\n                // If it's a page activity, we simply add the page HTML as the modal body.\n                // Otherwise, we set the body by rendering from a template.\n                if (objectType === 'page') {\n                    modalRoot.addClass('mod_' + objectType);\n                    stopAllVideosOnDismiss(modalRoot);\n                    Fragment.loadFragment(\n                        'format_tiles', `get_cm_content`, moduleContextId, {contextid: moduleContextId}\n                    )\n                       .done(function(html, js) {\n                            modal.setBody(html);\n                            Templates.runTemplateJS(js);\n                        });\n                } else {\n                    // Render the modal body and set it to the page.\n                    // First a blank template data object.\n                    var templateData = {\n                        id: cmId,\n                        objectType: null,\n                        width: \"100%\",\n                        height: Math.round(win.height() - 60), // Embedded object height in modal - make as high as poss.\n                        cmid: cmId,\n                        tileid: sectionNum,\n                        isediting: 0,\n                        sesskey: config.sesskey,\n                        activityname: title,\n                        config: {wwwroot: config.wwwroot},\n                        completionstring: '',\n                        description: descriptionHTML\n                    };\n\n                    var template = null;\n                    if (objectType === \"html\") {\n                        templateData.objectType = \"text/html\";\n                        template = 'format_tiles/embed_file_modal_body';\n                    } else if (objectType === \"pdf\") {\n                        templateData.objectType = 'application/pdf';\n                        // Issue #222 - Safari second page load of PDF.\n                        // Safari fails to re-load cached PDF, so for now bust cache by adding ?t={time}.\n                        // (Reason seems to be related to 'Accept-Ranges: bytes' in response from readfile_accel()).\n                        templateData.cachebustparam = isSafari ? Date.now() : null;\n                        template = 'format_tiles/embed_file_modal_body';\n                    } else if (objectType === \"url\") {\n                        templateData.objectType = 'url';\n                        template = 'format_tiles/embed_url_modal_body';\n                    }\n\n                    const redirectModule =\n                        ['pdf', 'html'].includes(objectType) ? 'resource' : objectType;\n                    if (template !== null) {\n                        Templates.render(template, templateData).done(function (html) {\n                            modal.setBody(html);\n                            modalRoot.find(Selector.modalBody).animate({\"min-height\": Math.round(win.height() + 20)}, \"fast\");\n\n                            if (objectType === \"html\" || objectType === 'url') {\n                                // HTML files only - set widths to 100% since they may contain embedded videos etc.\n                                modalRoot.find(Selector.modal).animate({\"max-width\": \"100%\"}, \"fast\");\n                                modalRoot.find(Selector.modalDialog).animate({\"max-width\": \"100%\"}, \"fast\");\n                                modalRoot.find(Selector.modalBody).animate({\"max-width\": \"100%\"}, \"fast\");\n                                stopAllVideosOnDismiss(modalRoot);\n                                if (objectType === 'url') {\n                                    modalRoot.find(Selector.modalBody).addClass(\"text-center\");\n                                }\n                            } else if (objectType === \"pdf\") {\n                                // Otherwise (e.g. for PDF) we don't need 100% width.\n                                modalRoot.find(Selector.modal).animate({\"max-width\": modalMinWidth()}, \"fast\");\n                                // We do modal-dialog too since Moove theme uses it.\n                                modalRoot.find(Selector.modalDialog).animate({\"max-width\": modalMinWidth()}, \"fast\");\n                            }\n\n                        }).fail(() => {\n                            window.location.href = `${config.wwwroot}/mod/${redirectModule}/view.php?id=${cmId}`;\n                        });\n                    } else {\n                        window.location.href = `${config.wwwroot}/mod/${redirectModule}/view.php?id=${cmId}`;\n                    }\n                }\n\n                // Render the modal header / title and set it to the page.\n                var headerTemplateData = {\n                    cmid: cmId,\n                    activityname: title,\n                    tileid: sectionNum,\n                    showDownload: objectType === \"pdf\" ? 1 : 0,\n                    showNewWindow: [\"pdf\", 'url'].includes(objectType) ? 1 : 0,\n                    forModal: true,\n                    config: {wwwroot: config.wwwroot}\n                };\n                if (completionEnabled) {\n                    headerTemplateData.istrackeduser = 1;\n                    headerTemplateData.hascompletion = 1;\n                    const oldState = existingCompletionState === 1;\n\n                    // Core completion button template has 'overallcomplete' arg relating to this cm.\n                    // See course/templates/completion_manual.mustache.\n                    headerTemplateData.overallcomplete = oldState ? 1 : 0;\n                    headerTemplateData.overallincomplete = oldState ? 0 : 1;\n                    headerTemplateData.completionIsManual = isManualCompletion;\n                    if (!headerTemplateData.completionIsManual) {\n                        // Auto completion has different vars for core template core_course/completion_automatic.\n                        headerTemplateData.statuscomplete = headerTemplateData.overallcomplete;\n                        headerTemplateData.statusincomplete = headerTemplateData.overallincomplete;\n                    }\n                    // Trigger event to check if other items in course have updated availability.\n                    if (oldState !== headerTemplateData.completionstate) {\n                        require([\"format_tiles/completion\"], function (completion) {\n                            completion.triggerCompletionChangedEvent(parseInt(sectionNum), parseInt(cmId));\n                        });\n                    }\n                }\n\n                Templates.render(\"format_tiles/embed_module_modal_header_btns\", headerTemplateData).done(function (html) {\n                    modalRoot.find(Selector.embedModuleButtons).remove();\n                    modalRoot.find($('button.close')).remove();\n                    modalRoot.find($('button.btn-close')).remove(); // Moodle 4.5+.\n                    modalRoot.find(Selector.modalHeader).append(html);\n                    modalRoot.find(Selector.closeBtn).detach().appendTo(modalRoot.find(Selector.embedModuleButtons));\n                    const toggleCompletionSelector = '[data-action=\"toggle-manual-completion\"]';\n                    modalRoot.find(toggleCompletionSelector).on('click', () => {\n                        require([\"format_tiles/completion\"], function (completion) {\n                            // In this case, core will handle the request to set the new completion value in the DB.\n                            // We wait a moment to allow that to get a head start.\n                            // Then we trigger an event which course.js will see and update section content to show new statuses.\n                            // Use will not notice this as they are looking at the modal, but it's ready when they dismiss modal.\n                            setTimeout(() => {\n                                completion.triggerCompletionChangedEvent(\n                                    parseInt(modalRoot.data('section')), parseInt(modalRoot.data(\"cmid\"))\n                                );\n                            }, 300);\n                        });\n                    });\n                }).fail(Notification.exception);\n\n                // Allow a short delay before we resize the modal, and check a few times, as content may be loading.\n                setTimeout(() => {\n                    modalHeightChangeWatcher(modalRoot, 3, 1000);\n                }, 500);\n\n                return true;\n            });\n            return false;\n        };\n\n        /**\n         * Resize the modal to account for its content.\n         * @param {object} modalRoot\n         */\n        var resizeModal = function(modalRoot) {\n            modalRoot.find(Selector.modal).animate({\"max-width\": modalMinWidth()}, \"fast\");\n\n            var MODAL_MARGIN = 70;\n\n            // If the modal contains a Moodle mediaplayer div, remove the max width css rule which Moodle applies.\n            // Otherwise video will be 400px max wide.\n            var mediaPlayer = $(Selector.moodleMediaPlayer);\n            mediaPlayer.find(\"div\").each(function(index, child) {\n                $(child).css(\"max-width\", \"\");\n            });\n            if (mediaPlayer.length > 0) {\n                stopAllVideosOnDismiss(modalRoot);\n            }\n\n            // If the activity contains an iframe (e.g. is a page with a YouTube video in it, or H5P), ensure modal is big enough.\n            // Do this for every iframe in the course module.\n            modalRoot.find(Selector.iframe).each(function (index, iframe) {\n\n                const iframeSelector = $(iframe);\n\n                // Get the modal.\n                var modal;\n                // Boost calls the modal \"modal dialog\" so try this first.\n                modal = modalRoot.find(Selector.modalDialog);\n\n                // If no luck, try what Clean and Adaptable do instead.\n                if (modal.length === 0) {\n                    modal = modalRoot.find(Selector.modal);\n                }\n\n                // Now check and adjust the width of the modal.\n                var iframeWidth = Math.min(iframeSelector.width(), win.width());\n                if (iframeWidth > modal.width() - MODAL_MARGIN) {\n                    modal.animate(\n                        {\"max-width\": Math.max(iframeWidth + MODAL_MARGIN, modalMinWidth())},\n                        \"fast\"\n                    );\n                    modalRoot.find(Selector.modal).animate(\n                        {\"max-width\": Math.max(iframeWidth + MODAL_MARGIN, modalMinWidth())},\n                        \"fast\"\n                    );\n                }\n\n                // Then the height of the modal body.\n                var modalBody = modalRoot.find(Selector.modalBody);\n                if (iframeSelector.height() > modalBody.height() - MODAL_MARGIN) {\n                    iframeSelector.attr('height', modalBody.height() - MODAL_MARGIN);\n                }\n                stopAllVideosOnDismiss(modalRoot);\n            });\n        };\n\n        /**\n         * Check the modal height to see if the iframe in it is bigger.  If it is, adjust modal height up.\n         * Do this a few times so that, if iframe content is loading, we can check after it's loaded.\n         * @param {object} modalRoot\n         * @param {number} howManyChecks\n         * @param {number}duration\n         * @param {number} oldHeight\n         */\n        const modalHeightChangeWatcher = function (modalRoot, howManyChecks, duration, oldHeight = 0) {\n            const iframe = modalRoot.find(Selector.modalBody);\n            if (iframe) {\n                const newHeight = Math.round(iframe.height());\n                if (newHeight && newHeight > oldHeight + 10) {\n                    resizeModal(modalRoot);\n                }\n                if (howManyChecks > 0) {\n                    setTimeout(() => {\n                        modalHeightChangeWatcher(modalRoot, howManyChecks - 1, duration, newHeight);\n                    }, duration);\n                }\n            }\n        };\n\n        /**\n         * Do we need a modal for this cm?\n         * @param {number} cmId course module ID\n         * @param {string} url\n         * @return boolean\n         */\n        const modalRequired = function(cmId, url) {\n            if (tilesConfig.modalallowedmodnames === undefined) {\n                return false;\n            }\n            if (tilesConfig.modalallowedcmids === undefined) {\n                return false;\n            }\n            if (!(tilesConfig.modalallowedcmids).includes(cmId)) {\n                return false;\n            }\n\n            return ((tilesConfig.modalallowedmodnames).includes('page') && url.startsWith(`${config.wwwroot}/mod/page/view.php`))\n                || ((tilesConfig.modalallowedmodnames).includes('url') && url.startsWith(`${config.wwwroot}/mod/url/view.php`))\n                || ((tilesConfig.modalallowedmodnames).includes('pdf') && url.startsWith(`${config.wwwroot}/mod/resource/view.php`))\n                || ((tilesConfig.modalallowedmodnames).includes('html')\n                    && url.startsWith(`${config.wwwroot}/mod/resource/view.php`));\n        };\n\n        return {\n            init: function (courseIdInit, isEditing, pageType, launchModalCmid, usingJsNav) {\n                courseId = parseInt(courseIdInit);\n                $(document).ready(function () {\n                    tilesConfig = $('#format-tiles-js-config').data();\n                    const courseIndex = $('nav#courseindex');\n\n                    if (['course-view-tiles', 'section-view-tiles', 'course-view-section-tiles'].includes(pageType)) {\n                        // We are on a main tiles page, /course/view.php or /course/section.php in Moodle 4.4+.\n                        // If any link in the course index on the left is clicked, check if it needs a modal.\n                        // If it does, launch the modal instead of following the link.\n                        // This isn't ideal but saves plugin re-implementing / maintaining large volume of course index code.\n                        // TODO use reactive UI - courseformat/activity:openAnchor in course/format/amd/src/local/courseindex.\n                        if (!isEditing && courseIndex.length > 0) {\n                            courseIndex.on('click', function(e) {\n                                const target = $(e.target);\n                                const link = target.hasClass('courseindex-link') ? target : target.find('a.courseindex-link');\n                                if (link && link.data('for') === 'cm_name') {\n                                    e.preventDefault();\n                                    const linkUrl = link.attr('href');\n                                    if (linkUrl) {\n                                        const cmId = link.closest('li.courseindex-item').data('id');\n                                        ajax.call([{\n                                            methodname: \"format_tiles_get_course_mod_info\", args: {cmid: cmId}\n                                        }])[0].done(function (data) {\n                                            const expandedSection = $(`li#section-${data.sectionnumber}.state-visible`);\n                                            if (modalRequired(cmId, linkUrl)) {\n                                                if (!data || !data.modalallowed) {\n                                                    window.location.href = linkUrl;\n                                                    return;\n                                                }\n                                                if (usingJsNav) {\n                                                    if (expandedSection.length === 0) {\n                                                        require([\"format_tiles/course\"], function (course) {\n                                                            course.populateAndExpandSection(\n                                                                data.coursecontextid, data.sectionid, data.sectionnumber\n                                                            );\n                                                        });\n                                                    }\n                                                    launchCmModal(\n                                                        cmId,\n                                                        data.modulecontextid,\n                                                        data.sectionnumber,\n                                                        data.name,\n                                                        data.modaltype,\n                                                        data.completionenabled ? 1 : 0,\n                                                        data.iscomplete ? 1 : 0,\n                                                        data.ismanualcompletion,\n                                                        data.description,\n                                                    );\n                                                } else {\n                                                    window.location.href = config.wwwroot\n                                                        + `/course/view.php?id=${courseId}`\n                                                        + `&section=${data.sectionnumber}&cmid=${cmId}`;\n                                                }\n                                            } else {\n                                                // Link URL may be anchor e.g. #module-138 if the item is a label.\n                                                const isAnchorLink = link.data('anchor') || linkUrl.startsWith('#');\n                                                if (!isAnchorLink) {\n                                                    window.location.href = linkUrl;\n                                                } else {\n                                                    if (usingJsNav) {\n                                                        if (expandedSection.length === 0) {\n                                                            require([\"format_tiles/course\"], function (course) {\n                                                                course.populateAndExpandSection(\n                                                                    data.coursecontextid, data.sectionid, data.sectionnumber\n                                                                );\n                                                            });\n                                                        }\n                                                    } else {\n                                                        window.location.href = config.wwwroot\n                                                            + `/course/view.php?id=${courseId}`\n                                                            + `&section=${data.sectionnumber}`;\n                                                    }\n                                                }\n                                            }\n                                        })\n                                        .fail(function() {\n                                            window.location.href = linkUrl;\n                                        });\n                                    }\n                                }\n                            });\n                        }\n\n                        // If we are passing ?cmid=xxx in the URL this suggests we are trying to launch course mod modal.\n                        // This would be from clicking a course index link while in another activity.\n                        // E.g. from /mod/xxx/view.php for another course module.\n                        // This isn't ideal but saves this plugin re-implementing / maintaining large volume of course index code.\n                        if (launchModalCmid) {\n                            ajax.call([{\n                                methodname: \"format_tiles_get_course_mod_info\", args: {cmid: launchModalCmid}\n                            }])[0].done(function (data) {\n                                if (data && data.modalallowed && data.courseid === courseId) {\n                                    const expandedSection = $(`li#section-${data.sectionnumber}.state-visible`);\n                                    if (expandedSection.length === 0) {\n                                        if (usingJsNav) {\n                                            require([\"format_tiles/course\"], function (course) {\n                                                course.populateAndExpandSection(\n                                                    data.coursecontextid, data.sectionid, data.sectionnumber\n                                                );\n                                            });\n                                        }\n                                    }\n\n                                    launchCmModal(\n                                        launchModalCmid,\n                                        data.modulecontextid,\n                                        data.sectionnumber,\n                                        data.name,\n                                        data.modaltype,\n                                        data.completionenabled ? 1 : 0,\n                                        data.iscomplete ? 1 : 0,\n                                        data.ismanualcompletion,\n                                        data.description,\n                                    );\n                                }\n                            });\n                        }\n\n                        var pageContent = $(Selector.pageContent);\n                        if (pageContent.length === 0) {\n                            // Some themes e.g. RemUI do not have a #page-content div, so use #region-main.\n                            pageContent = $(Selector.regionMain);\n                        }\n\n                        pageContent.on(\"keydown\", `[data-action=\"launch-tiles-cm-modal\"]`, function (e) {\n                            const ENTER_KEY = 13;\n                            if (e.keyCode === ENTER_KEY) {\n                                // User has tabbed to a modal capable activity and pressed enter.\n                                // To improve accessibility, do not launch a modal but show them standard activity screen.\n                                e.preventDefault();\n                                const url = $(e.target).attr('href');\n                                if (url) {\n                                    window.location.href = url;\n                                }\n                            }\n                        });\n\n                        pageContent.on(\"click\", `[data-action=\"launch-tiles-cm-modal\"]`, function (e) {\n                            // If click is on a completion checkbox within activity, ignore here as handled elsewhere.\n                            const tgt = $(e.target);\n                            const isExcludedControl = tgt.hasClass(CLASS.COMPLETION_CHECK_BOX)\n                                || tgt.parent().hasClass(CLASS.COMPLETION_CHECK_BOX)\n                                || tgt.hasClass(CLASS.COMPLETION_DROPDOWN)\n                                || tgt.parent().hasClass(CLASS.COMPLETION_DROPDOWN)\n                                || tgt.is(\":button\")\n                                || tgt.hasClass('expanded-content') // \"Show less\" link on restrictions.\n                                || tgt.hasClass('collapsed-content'); // \"Show more\" link on restrictions\n                            if (isExcludedControl) {\n                                return;\n                            }\n                            e.preventDefault();\n                            const currTgt = $(e.currentTarget);\n                            var clickedCmObject = currTgt.closest(\"li.activity\");\n                            const cmId = clickedCmObject.data('cmid');\n                            const moduleContextId = clickedCmObject.data('contextid');\n                            const sectionNum = clickedCmObject.closest(Selector.sectionMain).data('section');\n\n                            launchCmModal(\n                                cmId,\n                                moduleContextId,\n                                sectionNum,\n                                clickedCmObject.data('title'),\n                                clickedCmObject.data('modal'),\n                                clickedCmObject.hasClass(CLASS.COMPLETION_ENABLED),\n                                clickedCmObject.data('completion-state')\n                                    ? parseInt(clickedCmObject.data('completion-state')) : null,\n                                clickedCmObject.hasClass(CLASS.COMPLETION_MANUAL),\n                                clickedCmObject.find('.modal-description').html(),\n                            );\n                        });\n\n                        // Render the loading icon and append it to body so that we can use it later.\n                        Templates.render(\"format_tiles/loading\", {})\n                            .catch(Notification.exception)\n                            .done(function (html) {\n                                loadingIconHtml = html; // TODO get this from elsewhere.\n                            }).fail(Notification.exception);\n\n                    } else if (pageType.match('^mod-[a-z]+-view$')) {\n                        courseIndex.on('click', function (e) {\n                            const target = $(e.target);\n                            const link = target.hasClass('courseindex-link') ? target : target.find('a.courseindex-link');\n                            if (link && link.data('for') === 'cm_name') {\n                                e.preventDefault();\n                                const linkUrl = link.attr('href');\n                                if (linkUrl) {\n                                    const link = $(e.target);\n                                    const cmId = link.closest('li.courseindex-item').data('id');\n                                    if (modalRequired(cmId, linkUrl)) {\n                                        if (usingJsNav) {\n                                            window.location.href = `${config.wwwroot}/course/view.php?id=${courseId}&cmid=${cmId}`;\n                                        } else {\n                                            const sectionElement = link.closest('.courseindex-section');\n                                            const sectionNumber = sectionElement ? sectionElement.data('number') : 0;\n                                            window.location.href = `${config.wwwroot}/course/view.php?id=${courseId}`\n                                                + `&section=${sectionNumber}&cmid=${cmId}`;\n                                        }\n                                    } else {\n                                        window.location.href = linkUrl;\n                                    }\n                                }\n                            }\n                        });\n                    }\n                });\n            }\n        };\n    }\n);\n"],"names":["define","$","modalFactory","config","Templates","Notification","ajax","Fragment","ModalEvents","loadingIconHtml","win","window","courseId","tilesConfig","isSafari","test","navigator","userAgent","Selector","CLASS","modalMinWidth","Math","min","width","stopAllVideosOnDismiss","modal","on","hidden","iframes","find","objects","moodleMediaPlayer","length","remove","launchCmModal","cmId","moduleContextId","sectionNum","title","objectType","completionEnabled","existingCompletionState","isManualCompletion","descriptionHTML","create","type","types","DEFAULT","body","done","setLarge","show","setScrollable","modalRoot","root","modalId","attr","data","addClass","loadFragment","contextid","html","js","setBody","runTemplateJS","templateData","id","height","round","cmid","tileid","isediting","sesskey","activityname","wwwroot","completionstring","description","template","cachebustparam","Date","now","redirectModule","includes","render","animate","fail","location","href","headerTemplateData","showDownload","showNewWindow","forModal","istrackeduser","hascompletion","oldState","overallcomplete","overallincomplete","completionIsManual","statuscomplete","statusincomplete","completionstate","require","completion","triggerCompletionChangedEvent","parseInt","append","detach","appendTo","setTimeout","exception","modalHeightChangeWatcher","resizeModal","mediaPlayer","each","index","child","css","iframe","iframeSelector","iframeWidth","max","modalBody","howManyChecks","duration","oldHeight","newHeight","modalRequired","url","undefined","modalallowedmodnames","modalallowedcmids","startsWith","init","courseIdInit","isEditing","pageType","launchModalCmid","usingJsNav","document","ready","courseIndex","e","target","link","hasClass","preventDefault","linkUrl","closest","call","methodname","args","expandedSection","sectionnumber","modalallowed","course","populateAndExpandSection","coursecontextid","sectionid","modulecontextid","name","modaltype","completionenabled","iscomplete","ismanualcompletion","courseid","pageContent","keyCode","tgt","parent","is","clickedCmObject","currentTarget","catch","match","sectionElement","sectionNumber"],"mappings":";;;;;;;;;;;AA6BAA,uCAAO,CAAC,SAAU,qBAAsB,cAAe,iBAAkB,oBAAqB,YACtF,gBAAiB,sBACrB,SAAUC,EAAGC,aAAcC,OAAQC,UAAWC,aAAcC,KAAMC,SAAUC,iBAGpEC,sBACEC,IAAMT,EAAEU,YACVC,SACAC,kBACEC,SAAW,iCAAiCC,KAAKC,UAAUC,WAE3DC,eACK,SADLA,qBAEW,gBAFXA,mBAGS,cAHTA,qBAIW,gBAJXA,qBAKW,gBALXA,oBAMU,eANVA,2BASiB,uBATjBA,kBAUQ,eAVRA,qBAaW,gBAbXA,4BAckB,wBAdlBA,gBAeM,SAGNC,yBACkB,qBADlBA,wBAEiB,oBAFjBA,2BAKoB,qBALpBA,0BAMmB,sBAGnBC,cAAgB,kBACXC,KAAKC,IAAIZ,IAAIa,QAAS,OAO3BC,uBAAyB,SAASC,OACpCA,MAAMC,GAAGlB,YAAYmB,QAAQ,iBACnBC,QAAUH,MAAMI,KAAKX,iBACrBY,QAAUL,MAAMI,KAAK,UACrBE,kBAAoBN,MAAMI,KAAKX,6BAEjCU,QAAQI,QAAUF,QAAQE,QAAUD,kBAAkBC,SACtDP,MAAMQ,aAiBZC,cAAgB,SACdC,KAAMC,gBAAiBC,WAAYC,MAAOC,WAC1CC,kBAAmBC,wBAAyBC,mBAAoBC,wBAEpEzC,aAAa0C,OAAO,CAChBC,KAAM3C,aAAa4C,MAAMC,QACzBT,MAAOA,MACPU,KAAMvC,kBACPwC,MAAK,SAAUxB,OACdA,MAAMyB,WACNzB,MAAM0B,OACN1B,MAAM2B,eAAc,SACdC,UAAYpD,EAAEwB,MAAM6B,MACpBC,QAAU,mBAAqBpB,QAErClC,aAAMsD,UAAWtB,SACjBoB,UAAUG,KAAK,KAAMD,SACrBF,UAAUI,KAAK,OAAQtB,MACvBkB,UAAUI,KAAK,UAAWpB,YAC1BgB,UAAUK,SAAS,kBAIA,SAAfnB,WACAc,UAAUK,SAAS,OAASnB,YAC5Bf,uBAAuB6B,WACvB9C,SAASoD,aACL,gCAAkCvB,gBAAiB,CAACwB,UAAWxB,kBAE/Da,MAAK,SAASY,KAAMC,IAChBrC,MAAMsC,QAAQF,MACdzD,UAAU4D,cAAcF,WAE7B,KAGCG,aAAe,CACfC,GAAI/B,KACJI,WAAY,KACZhB,MAAO,OACP4C,OAAQ9C,KAAK+C,MAAM1D,IAAIyD,SAAW,IAClCE,KAAMlC,KACNmC,OAAQjC,WACRkC,UAAW,EACXC,QAASrE,OAAOqE,QAChBC,aAAcnC,MACdnC,OAAQ,CAACuE,QAASvE,OAAOuE,SACzBC,iBAAkB,GAClBC,YAAajC,iBAGbkC,SAAW,KACI,SAAftC,YACA0B,aAAa1B,WAAa,YAC1BsC,SAAW,sCACW,QAAftC,YACP0B,aAAa1B,WAAa,kBAI1B0B,aAAaa,eAAiBhE,SAAWiE,KAAKC,MAAQ,KACtDH,SAAW,sCACW,QAAftC,aACP0B,aAAa1B,WAAa,MAC1BsC,SAAW,2CAGTI,eACF,CAAC,MAAO,QAAQC,SAAS3C,YAAc,WAAaA,WACvC,OAAbsC,SACAzE,UAAU+E,OAAON,SAAUZ,cAAchB,MAAK,SAAUY,MACpDpC,MAAMsC,QAAQF,MACdR,UAAUxB,KAAKX,oBAAoBkE,QAAQ,cAAe/D,KAAK+C,MAAM1D,IAAIyD,SAAW,KAAM,QAEvE,SAAf5B,YAAwC,QAAfA,YAEzBc,UAAUxB,KAAKX,gBAAgBkE,QAAQ,aAAc,QAAS,QAC9D/B,UAAUxB,KAAKX,sBAAsBkE,QAAQ,aAAc,QAAS,QACpE/B,UAAUxB,KAAKX,oBAAoBkE,QAAQ,aAAc,QAAS,QAClE5D,uBAAuB6B,WACJ,QAAfd,YACAc,UAAUxB,KAAKX,oBAAoBwC,SAAS,gBAE1B,QAAfnB,aAEPc,UAAUxB,KAAKX,gBAAgBkE,QAAQ,aAAchE,iBAAkB,QAEvEiC,UAAUxB,KAAKX,sBAAsBkE,QAAQ,aAAchE,iBAAkB,YAGlFiE,MAAK,KACJ1E,OAAO2E,SAASC,eAAUpF,OAAOuE,wBAAeO,uCAA8B9C,SAGlFxB,OAAO2E,SAASC,eAAUpF,OAAOuE,wBAAeO,uCAA8B9C,UAKlFqD,mBAAqB,CACrBnB,KAAMlC,KACNsC,aAAcnC,MACdgC,OAAQjC,WACRoD,aAA6B,QAAflD,WAAuB,EAAI,EACzCmD,cAAe,CAAC,MAAO,OAAOR,SAAS3C,YAAc,EAAI,EACzDoD,UAAU,EACVxF,OAAQ,CAACuE,QAASvE,OAAOuE,aAEzBlC,kBAAmB,CACnBgD,mBAAmBI,cAAgB,EACnCJ,mBAAmBK,cAAgB,QAC7BC,SAAuC,IAA5BrD,wBAIjB+C,mBAAmBO,gBAAkBD,SAAW,EAAI,EACpDN,mBAAmBQ,kBAAoBF,SAAW,EAAI,EACtDN,mBAAmBS,mBAAqBvD,mBACnC8C,mBAAmBS,qBAEpBT,mBAAmBU,eAAiBV,mBAAmBO,gBACvDP,mBAAmBW,iBAAmBX,mBAAmBQ,mBAGzDF,WAAaN,mBAAmBY,iBAChCC,QAAQ,CAAC,4BAA4B,SAAUC,YAC3CA,WAAWC,8BAA8BC,SAASnE,YAAamE,SAASrE,iBAKpF/B,UAAU+E,OAAO,8CAA+CK,oBAAoBvC,MAAK,SAAUY,MAC/FR,UAAUxB,KAAKX,6BAA6Be,SAC5CoB,UAAUxB,KAAK5B,EAAE,iBAAiBgC,SAClCoB,UAAUxB,KAAK5B,EAAE,qBAAqBgC,SACtCoB,UAAUxB,KAAKX,sBAAsBuF,OAAO5C,MAC5CR,UAAUxB,KAAKX,mBAAmBwF,SAASC,SAAStD,UAAUxB,KAAKX,8BAEnEmC,UAAUxB,KADuB,4CACQH,GAAG,SAAS,KACjD2E,QAAQ,CAAC,4BAA4B,SAAUC,YAK3CM,YAAW,KACPN,WAAWC,8BACPC,SAASnD,UAAUI,KAAK,YAAa+C,SAASnD,UAAUI,KAAK,YAElE,cAGZ4B,KAAKhF,aAAawG,WAGrBD,YAAW,KACPE,yBAAyBzD,UAAW,EAAG,OACxC,MAEI,MAEJ,OAOP0D,YAAc,SAAS1D,WACvBA,UAAUxB,KAAKX,gBAAgBkE,QAAQ,aAAchE,iBAAkB,YAMnE4F,YAAc/G,EAAEiB,4BACpB8F,YAAYnF,KAAK,OAAOoF,MAAK,SAASC,MAAOC,OACzClH,EAAEkH,OAAOC,IAAI,YAAa,OAE1BJ,YAAYhF,OAAS,GACrBR,uBAAuB6B,WAK3BA,UAAUxB,KAAKX,iBAAiB+F,MAAK,SAAUC,MAAOG,cAE5CC,eAAiBrH,EAAEoH,YAGrB5F,MAKiB,KAHrBA,MAAQ4B,UAAUxB,KAAKX,uBAGbc,SACNP,MAAQ4B,UAAUxB,KAAKX,qBAIvBqG,YAAclG,KAAKC,IAAIgG,eAAe/F,QAASb,IAAIa,SACnDgG,YAAc9F,MAAMF,QA9BT,KA+BXE,MAAM2D,QACF,aAAc/D,KAAKmG,IAAID,YAhChB,GAgC4CnG,kBACnD,QAEJiC,UAAUxB,KAAKX,gBAAgBkE,QAC3B,aAAc/D,KAAKmG,IAAID,YApChB,GAoC4CnG,kBACnD,aAKJqG,UAAYpE,UAAUxB,KAAKX,oBAC3BoG,eAAenD,SAAWsD,UAAUtD,SA3CzB,IA4CXmD,eAAe9D,KAAK,SAAUiE,UAAUtD,SA5C7B,IA8Cf3C,uBAAuB6B,qBAYzByD,yBAA2B,SAAUzD,UAAWqE,cAAeC,cAAUC,iEAAY,QACjFP,OAAShE,UAAUxB,KAAKX,uBAC1BmG,OAAQ,OACFQ,UAAYxG,KAAK+C,MAAMiD,OAAOlD,UAChC0D,WAAaA,UAAYD,UAAY,IACrCb,YAAY1D,WAEZqE,cAAgB,GAChBd,YAAW,KACPE,yBAAyBzD,UAAWqE,cAAgB,EAAGC,SAAUE,aAClEF,YAWTG,cAAgB,SAAS3F,KAAM4F,iBACQC,IAArCnH,YAAYoH,4BAGsBD,IAAlCnH,YAAYqH,sBAGVrH,YAAYqH,kBAAmBhD,SAAS/C,QAIrCtB,YAAYoH,qBAAsB/C,SAAS,SAAW6C,IAAII,qBAAchI,OAAOuE,gCAC/E7D,YAAYoH,qBAAsB/C,SAAS,QAAU6C,IAAII,qBAAchI,OAAOuE,+BAC9E7D,YAAYoH,qBAAsB/C,SAAS,QAAU6C,IAAII,qBAAchI,OAAOuE,oCAC9E7D,YAAYoH,qBAAsB/C,SAAS,SACzC6C,IAAII,qBAAchI,OAAOuE,6CAGjC,CACH0D,KAAM,SAAUC,aAAcC,UAAWC,SAAUC,gBAAiBC,YAChE7H,SAAW4F,SAAS6B,cACpBpI,EAAEyI,UAAUC,OAAM,WACd9H,YAAcZ,EAAE,2BAA2BwD,aACrCmF,YAAc3I,EAAE,sBAElB,CAAC,oBAAqB,qBAAsB,6BAA6BiF,SAASqD,UAAW,EAMxFD,WAAaM,YAAY5G,OAAS,GACnC4G,YAAYlH,GAAG,SAAS,SAASmH,SACvBC,OAAS7I,EAAE4I,EAAEC,QACbC,KAAOD,OAAOE,SAAS,oBAAsBF,OAASA,OAAOjH,KAAK,yBACpEkH,MAA6B,YAArBA,KAAKtF,KAAK,OAAsB,CACxCoF,EAAEI,uBACIC,QAAUH,KAAKvF,KAAK,WACtB0F,QAAS,OACH/G,KAAO4G,KAAKI,QAAQ,uBAAuB1F,KAAK,MACtDnD,KAAK8I,KAAK,CAAC,CACPC,WAAY,mCAAoCC,KAAM,CAACjF,KAAMlC,SAC7D,GAAGc,MAAK,SAAUQ,YACZ8F,gBAAkBtJ,uBAAgBwD,KAAK+F,oCACzC1B,cAAc3F,KAAM+G,SAAU,KACzBzF,OAASA,KAAKgG,yBACf9I,OAAO2E,SAASC,KAAO2D,SAGvBT,YAC+B,IAA3Bc,gBAAgBvH,QAChBqE,QAAQ,CAAC,wBAAwB,SAAUqD,QACvCA,OAAOC,yBACHlG,KAAKmG,gBAAiBnG,KAAKoG,UAAWpG,KAAK+F,kBAIvDtH,cACIC,KACAsB,KAAKqG,gBACLrG,KAAK+F,cACL/F,KAAKsG,KACLtG,KAAKuG,UACLvG,KAAKwG,kBAAoB,EAAI,EAC7BxG,KAAKyG,WAAa,EAAI,EACtBzG,KAAK0G,mBACL1G,KAAKmB,cAGTjE,OAAO2E,SAASC,KAAOpF,OAAOuE,sCACD9D,6BACX6C,KAAK+F,+BAAsBrH,UAE9C,CAEkB4G,KAAKtF,KAAK,WAAayF,QAAQf,WAAW,KAIvDM,WAC+B,IAA3Bc,gBAAgBvH,QAChBqE,QAAQ,CAAC,wBAAwB,SAAUqD,QACvCA,OAAOC,yBACHlG,KAAKmG,gBAAiBnG,KAAKoG,UAAWpG,KAAK+F,kBAKvD7I,OAAO2E,SAASC,KAAOpF,OAAOuE,sCACD9D,6BACX6C,KAAK+F,eAb3B7I,OAAO2E,SAASC,KAAO2D,YAkBlC7D,MAAK,WACF1E,OAAO2E,SAASC,KAAO2D,gBAWvCV,iBACAlI,KAAK8I,KAAK,CAAC,CACPC,WAAY,mCAAoCC,KAAM,CAACjF,KAAMmE,oBAC7D,GAAGvF,MAAK,SAAUQ,SACdA,MAAQA,KAAKgG,cAAgBhG,KAAK2G,WAAaxJ,SAAU,CAE1B,IADPX,uBAAgBwD,KAAK+F,iCACzBxH,QACZyG,YACApC,QAAQ,CAAC,wBAAwB,SAAUqD,QACvCA,OAAOC,yBACHlG,KAAKmG,gBAAiBnG,KAAKoG,UAAWpG,KAAK+F,kBAM3DtH,cACIsG,gBACA/E,KAAKqG,gBACLrG,KAAK+F,cACL/F,KAAKsG,KACLtG,KAAKuG,UACLvG,KAAKwG,kBAAoB,EAAI,EAC7BxG,KAAKyG,WAAa,EAAI,EACtBzG,KAAK0G,mBACL1G,KAAKmB,qBAMjByF,YAAcpK,EAAEiB,sBACO,IAAvBmJ,YAAYrI,SAEZqI,YAAcpK,EAAEiB,sBAGpBmJ,YAAY3I,GAAG,mDAAoD,SAAUmH,MACvD,KACdA,EAAEyB,QAAuB,CAGzBzB,EAAEI,uBACIlB,IAAM9H,EAAE4I,EAAEC,QAAQtF,KAAK,QACzBuE,MACApH,OAAO2E,SAASC,KAAOwC,SAKnCsC,YAAY3I,GAAG,iDAAkD,SAAUmH,SAEjE0B,IAAMtK,EAAE4I,EAAEC,WACUyB,IAAIvB,SAAS7H,6BAChCoJ,IAAIC,SAASxB,SAAS7H,6BACtBoJ,IAAIvB,SAAS7H,4BACboJ,IAAIC,SAASxB,SAAS7H,4BACtBoJ,IAAIE,GAAG,YACPF,IAAIvB,SAAS,qBACbuB,IAAIvB,SAAS,4BAIpBH,EAAEI,qBAEEyB,gBADYzK,EAAE4I,EAAE8B,eACUxB,QAAQ,qBAChChH,KAAOuI,gBAAgBjH,KAAK,QAC5BrB,gBAAkBsI,gBAAgBjH,KAAK,aACvCpB,WAAaqI,gBAAgBvB,QAAQjI,sBAAsBuC,KAAK,WAEtEvB,cACIC,KACAC,gBACAC,WACAqI,gBAAgBjH,KAAK,SACrBiH,gBAAgBjH,KAAK,SACrBiH,gBAAgB1B,SAAS7H,0BACzBuJ,gBAAgBjH,KAAK,oBACf+C,SAASkE,gBAAgBjH,KAAK,qBAAuB,KAC3DiH,gBAAgB1B,SAAS7H,yBACzBuJ,gBAAgB7I,KAAK,sBAAsBgC,WAKnDzD,UAAU+E,OAAO,uBAAwB,IACpCyF,MAAMvK,aAAawG,WACnB5D,MAAK,SAAUY,MACZpD,gBAAkBoD,QACnBwB,KAAKhF,aAAawG,gBAElB0B,SAASsC,MAAM,sBACtBjC,YAAYlH,GAAG,SAAS,SAAUmH,SACxBC,OAAS7I,EAAE4I,EAAEC,QACbC,KAAOD,OAAOE,SAAS,oBAAsBF,OAASA,OAAOjH,KAAK,yBACpEkH,MAA6B,YAArBA,KAAKtF,KAAK,OAAsB,CACxCoF,EAAEI,uBACIC,QAAUH,KAAKvF,KAAK,WACtB0F,QAAS,OACHH,KAAO9I,EAAE4I,EAAEC,QACX3G,KAAO4G,KAAKI,QAAQ,uBAAuB1F,KAAK,SAClDqE,cAAc3F,KAAM+G,YAChBT,WACA9H,OAAO2E,SAASC,eAAUpF,OAAOuE,uCAA8B9D,0BAAiBuB,UAC7E,OACG2I,eAAiB/B,KAAKI,QAAQ,wBAC9B4B,cAAgBD,eAAiBA,eAAerH,KAAK,UAAY,EACvE9C,OAAO2E,SAASC,KAAO,UAAGpF,OAAOuE,uCAA8B9D,6BAC7CmK,+BAAsB5I,WAG5CxB,OAAO2E,SAASC,KAAO2D"}