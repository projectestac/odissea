/**
 * Load the format_tiles JavaScript for the course edit settings page /course/edit.php?id=xxx
 *
 * @module      format_tiles/completion
 * @copyright   2018 David Watson {@link http://evolutioncode.uk}
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("format_tiles/completion",["jquery","core/templates","core/config","core/ajax","core/str","core_course/manual_completion_toggle"],(function($,Templates,config,ajax,str,coreManualCompletion){var courseId;const dataKeys_numberOutOf="data-numoutof",dataKeys_section="data-section",Selector_section="li.section.main",Selector_toggleCompletionSubtile='[data-action="tiles-toggle-manual-completion-subtile"]',Selector_tileNumber="#tile-",Selector_progressIndicatorSecNumber="#tileprogress-",Selector_tile=".tile",Selector_spacer=".spacer",Selector_availabilityinfo=".availabilityinfo";var progressTemplateData=function(tileNumber,numComplete,outOf,asPercent){var data={tileid:tileNumber,numComplete:numComplete,numOutOf:outOf,showAsPercent:asPercent,percent:outOf>0?Math.round(numComplete/outOf*100):0,percentCircumf:106.8,percentOffset:outOf>0?Math.round((outOf-numComplete)/outOf*106.8):0,isComplete:!1,isSingleDigit:!1,hastilephoto:$(Selector_tileNumber+tileNumber).hasClass("phototile")};return data.isOverall=0===tileNumber?1:0,outOf>0&&numComplete>=outOf&&(data.isComplete=!0),data.percent<10&&(data.isSingleDigit=!0),data};const triggerCompletionChangedEvent=function(sectionNum,cmId){if(sectionNum>0||cmId>0){const data={courseid:courseId,section:sectionNum,cmid:cmId};$(document).trigger("format-tiles-completion-changed",data)}},updateSectionsInfo=function(sections,overallcomplete,overalloutof){var newValue,outOf;sections.forEach((sec=>{if(sec.sectionnum>0){const tile=$(Selector_tileNumber+sec.sectionnum);sec.isavailable&&tile.hasClass("tile-restricted")?tile.removeClass("tile-restricted"):sec.isavailable||tile.addClass("tile-restricted"),sec.isclickable&&!tile.hasClass("tile-clickable")?tile.addClass("tile-clickable"):!sec.isclickable&&tile.hasClass("tile-clickable")&&tile.removeClass("tile-clickable"),sec.iscomplete?tile.addClass("is-complete"):tile.removeClass("is-complete");const progressIndicator=$(Selector_progressIndicatorSecNumber+sec.sectionnum.toString());progressIndicator.length&&(sectionNum=sec.sectionnum,tileProgressIndicator=progressIndicator,(newTileProgressValue=sec.numcomplete)<0||newTileProgressValue>tileProgressIndicator.attr(dataKeys_numberOutOf)||sectionNum&&Templates.render("format_tiles/progress",progressTemplateData(sectionNum,newTileProgressValue,parseInt(tileProgressIndicator.attr(dataKeys_numberOutOf)),tileProgressIndicator.hasClass("percent"))).done((function(html){tileProgressIndicator.replaceWith(html)})));const availabilityInfoDiv=tile.find(Selector_availabilityinfo);availabilityInfoDiv.length>0&&sec.isavailable&&!sec.availabilitymessage?availabilityInfoDiv.fadeOut():!sec.isavailable&&sec.availabilitymessage&&(availabilityInfoDiv.length>0?(availabilityInfoDiv.html="NEW"+sec.availabilitymessage,availabilityInfoDiv.fadeIn()):Templates.render("format_tiles/availability_info",{availabilitymessage:sec.availabilitymessage,visible:!0}).done((function(html){progressIndicator.replaceWith(html)})))}var sectionNum,tileProgressIndicator,newTileProgressValue})),newValue=overallcomplete,outOf=overalloutof,Templates.render("format_tiles/progress",progressTemplateData(0,newValue,outOf,!0)).done((function(html){$("#tileprogress-0").replaceWith(html).fadeOut(0).animate({opacity:1},500)}))};return{init:function(courseIdInit){courseId=courseIdInit,$(document).ready((function(){var loadingString="...";str.get_strings([{key:"loading",component:"format_tiles"}]).done((function(s){loadingString=s[0]+"  ..."})),$("body").on("click",Selector_toggleCompletionSubtile,(function(e){const currentTarget=$(e.currentTarget),section=currentTarget.closest("li.section");currentTarget.replaceWith('<span class="completionspinner spinner-grow spinner-grow-sm text-secondary mt-2 mr-2" role="status"><span class="sr-only">'+loadingString+"</span></span>");const cmId=parseInt(currentTarget.data("cmid"));if(ajax.call([{methodname:"core_completion_update_activity_completion_status_manually",args:{cmid:cmId,completed:1!==currentTarget.data("complete")}}])[0].done((res=>{!0===res.status&&triggerCompletionChangedEvent(parseInt(section.attr("data-section")),cmId)})),0!==currentTarget.closest(".embed-module-buttons").length){const cmId=currentTarget.data("cmid"),sectionNum=$("li#module-"+cmId).closest(Selector_section).attr(dataKeys_section);triggerCompletionChangedEvent(sectionNum?parseInt(sectionNum):0,cmId?parseInt(cmId):0)}}));var pageContent=$("#page-content");0===pageContent.length&&(pageContent=$("#region-main")),$("li.section a").on("click",(function(e){const target=$(e.target);if(target.attr("onclick")&&0===target.attr("onclick").indexOf("window.open")){const cm=target.closest("li.activity");if(cm.hasClass("completion-view")){const section=target.closest("li.section").data("section");triggerCompletionChangedEvent(section,cm.data("cmid"))}}})),coreManualCompletion.init()}))},triggerCompletionChangedEvent:function(sectionNum,cmid){triggerCompletionChangedEvent(sectionNum,cmid)},updateTileInformation:function(sectionNumbers){try{void 0===(sectionNums=sectionNumbers)&&(sectionNums=$(Selector_tile).not(Selector_spacer).map(((i,t)=>parseInt($(t).attr(dataKeys_section)))).toArray()),ajax.call([{methodname:"format_tiles_get_section_information",args:{courseid:courseId,sectionnums:sectionNums}}])[0].done((res=>{updateSectionsInfo(res.sections,res.overall.complete,res.overall.outof)})).fail((err=>{require(["core/log"],(function(log){log.debug("Failed to get section information to check completion status of section"),log.debug(err)}))}))}catch(err){require(["core/log"],(function(log){log.debug(err)}))}var sectionNums},updateSectionsInfo:function(sections,overallcomplete,overalloutof){updateSectionsInfo(sections,overallcomplete,overalloutof)}}}));

//# sourceMappingURL=completion.min.js.map