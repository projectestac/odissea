function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}define("core_course/local/activitychooser/dialogue",["exports","jquery","core/modal_events","core_course/local/activitychooser/selectors","core/templates","core/key_codes","core/loadingicon","core_course/local/activitychooser/repository","core/notification","core/utils"],(function(_exports,_jquery,ModalEvents,_selectors,Templates,_key_codes,_loadingicon,Repository,_notification,_utils){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.displayChooser=void 0,_jquery=_interopRequireDefault(_jquery),ModalEvents=_interopRequireWildcard(ModalEvents),_selectors=_interopRequireDefault(_selectors),Templates=_interopRequireWildcard(Templates),Repository=_interopRequireWildcard(Repository),_notification=_interopRequireDefault(_notification);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var _ref3,_ref6,_ref7,getPlugin=function(pluginName){return"function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require([pluginName],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require(pluginName)):Promise.resolve(_systemImportTransformerGlobalIdentifier[pluginName])},showModuleHelp=function(carousel,moduleData){var modal=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null!==modal&&!0===moduleData.showFooter&&modal.setFooter(Templates.render("core_course/local/activitychooser/footer_partial",moduleData));var help=carousel.find(_selectors.default.regions.help)[0];help.innerHTML="",help.classList.add("m-auto");var spinnerPromise=(0,_loadingicon.addIconToContainer)(help),transitionPromiseResolver=null,transitionPromise=new Promise((function(resolve){transitionPromiseResolver=resolve})),contentPromise=Templates.renderForPromise("core_course/local/activitychooser/help",moduleData);Promise.all([contentPromise,spinnerPromise,transitionPromise]).then((function(_ref){var _ref2$=_slicedToArray(_ref,1)[0],html=_ref2$.html,js=_ref2$.js;return Templates.replaceNodeContents(help,html,js)})).then((function(){return help.querySelector(_selectors.default.regions.chooserSummary.header).focus(),help})).catch(_notification.default.exception),carousel.one("slid.bs.carousel",(function(){transitionPromiseResolver()})),carousel.carousel("next")},manageFavouriteState=(_ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee(modalBody,caller,partialFavourite){var isFavourite,id,name,internal;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(isFavourite=caller.dataset.favourited,id=caller.dataset.id,name=caller.dataset.name,internal=caller.dataset.internal,"true"!==isFavourite){_context.next=10;break}return _context.next=7,Repository.unfavouriteModule(name,id);case 7:partialFavourite(internal,!1,modalBody),_context.next=13;break;case 10:return _context.next=12,Repository.favouriteModule(name,id);case 12:partialFavourite(internal,!0,modalBody);case 13:case"end":return _context.stop()}}),_callee)}))),function(_x,_x2,_x3){return _ref3.apply(this,arguments)}),initChooserOptionsKeyboardNavigation=function(body,mappedModules,chooserOptionsContainer){var modal=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,chooserOptions=chooserOptionsContainer.querySelectorAll(_selectors.default.regions.chooserOption.container);Array.from(chooserOptions).forEach((function(element){return element.addEventListener("keydown",(function(e){if((e.keyCode===_key_codes.enter||e.keyCode===_key_codes.space)&&e.target.matches(_selectors.default.actions.optionActions.showSummary)){e.preventDefault();var moduleName=e.target.closest(_selectors.default.regions.chooserOption.container).dataset.modname,moduleData=mappedModules.get(moduleName),carousel=(0,_jquery.default)(body.querySelector(_selectors.default.regions.carousel));carousel.carousel({interval:!1,pause:!0,keyboard:!1}),moduleData.showFooter=modal.hasFooterContent(),showModuleHelp(carousel,moduleData,modal)}if(e.keyCode===_key_codes.arrowRight){e.preventDefault();var currentOption=e.target.closest(_selectors.default.regions.chooserOption.container),nextOption=currentOption.nextElementSibling,firstOption=chooserOptionsContainer.firstElementChild,toFocusOption=clickErrorHandler(nextOption,firstOption);focusChooserOption(toFocusOption,currentOption)}if(e.keyCode===_key_codes.arrowLeft){e.preventDefault();var _currentOption=e.target.closest(_selectors.default.regions.chooserOption.container),previousOption=_currentOption.previousElementSibling,lastOption=chooserOptionsContainer.lastElementChild,_toFocusOption=clickErrorHandler(previousOption,lastOption);focusChooserOption(_toFocusOption,_currentOption)}if(e.keyCode===_key_codes.home){e.preventDefault();var _currentOption2=e.target.closest(_selectors.default.regions.chooserOption.container),_firstOption=chooserOptionsContainer.firstElementChild;focusChooserOption(_firstOption,_currentOption2)}if(e.keyCode===_key_codes.end){e.preventDefault();var _currentOption3=e.target.closest(_selectors.default.regions.chooserOption.container),_lastOption=chooserOptionsContainer.lastElementChild;focusChooserOption(_lastOption,_currentOption3)}}))}))},focusChooserOption=function(currentChooserOption){var previousChooserOption=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null!==previousChooserOption&&toggleFocusableChooserOption(previousChooserOption,!1),toggleFocusableChooserOption(currentChooserOption,!0),currentChooserOption.focus()},toggleFocusableChooserOption=function(chooserOption,isFocusable){var chooserOptionLink=chooserOption.querySelector(_selectors.default.actions.addChooser),chooserOptionHelp=chooserOption.querySelector(_selectors.default.actions.optionActions.showSummary),chooserOptionFavourite=chooserOption.querySelector(_selectors.default.actions.optionActions.manageFavourite);isFocusable?(chooserOption.tabIndex=0,chooserOptionLink.tabIndex=0,chooserOptionHelp.tabIndex=0,chooserOptionFavourite.tabIndex=0):(chooserOption.tabIndex=-1,chooserOptionLink.tabIndex=-1,chooserOptionHelp.tabIndex=-1,chooserOptionFavourite.tabIndex=-1)},clickErrorHandler=function(item,fallback){return null!==item?item:fallback},renderSearchResults=(_ref6=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(searchResultsContainer,searchResultsData){var templateData,_yield$Templates$rend,html,js;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return templateData={searchresultsnumber:searchResultsData.length,searchresults:searchResultsData},_context4.next=3,Templates.renderForPromise("core_course/local/activitychooser/search_results",templateData);case 3:return _yield$Templates$rend=_context4.sent,html=_yield$Templates$rend.html,js=_yield$Templates$rend.js,_context4.next=8,Templates.replaceNodeContents(searchResultsContainer,html,js);case 8:case"end":return _context4.stop()}}),_callee4)}))),function(_x6,_x7){return _ref6.apply(this,arguments)}),toggleSearchResultsView=(_ref7=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(modal,mappedModules,searchQuery){var modalBody,searchResultsContainer,chooserContainer,clearSearchButton,searchResultsData,searchResultItemsContainer,firstSearchResultItem;return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(modalBody=modal.getBody()[0],searchResultsContainer=modalBody.querySelector(_selectors.default.regions.searchResults),chooserContainer=modalBody.querySelector(_selectors.default.regions.chooser),clearSearchButton=modalBody.querySelector(_selectors.default.actions.clearSearch),!(searchQuery.length>0)){_context5.next=16;break}return searchResultsData=searchModules(mappedModules,searchQuery),_context5.next=8,renderSearchResults(searchResultsContainer,searchResultsData);case 8:searchResultItemsContainer=searchResultsContainer.querySelector(_selectors.default.regions.searchResultItems),(firstSearchResultItem=searchResultItemsContainer.querySelector(_selectors.default.regions.chooserOption.container))&&(toggleFocusableChooserOption(firstSearchResultItem,!0),initChooserOptionsKeyboardNavigation(modalBody,mappedModules,searchResultItemsContainer,modal)),clearSearchButton.classList.remove("d-none"),chooserContainer.setAttribute("hidden","hidden"),searchResultsContainer.removeAttribute("hidden"),_context5.next=19;break;case 16:clearSearchButton.classList.add("d-none"),searchResultsContainer.setAttribute("hidden","hidden"),chooserContainer.removeAttribute("hidden");case 19:case"end":return _context5.stop()}}),_callee5)}))),function(_x8,_x9,_x10){return _ref7.apply(this,arguments)}),searchModules=function(modules,searchTerm){if(""===searchTerm)return modules;searchTerm=searchTerm.toLowerCase();var searchResults=[];return modules.forEach((function(activity){var activityName=activity.title.toLowerCase(),activityDesc=activity.help.toLowerCase();(activityName.includes(searchTerm)||activityDesc.includes(searchTerm))&&searchResults.push(activity)})),searchResults},disableFocusAllChooserOptions=function(sectionChooserOptions){sectionChooserOptions.querySelectorAll(_selectors.default.regions.chooserOption.container).forEach((function(chooserOption){toggleFocusableChooserOption(chooserOption,!1)}))};_exports.displayChooser=function(modalPromise,sectionModules,partialFavourite,footerData){var mappedModules=new Map;sectionModules.forEach((function(module){mappedModules.set(module.componentname+"_"+module.link,module)})),modalPromise.then((function(modal){return function(modal,mappedModules,partialFavourite,footerData){var _ref4,_ref5,bodyClickListener=(_ref4=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(e){var carousel,module,moduleName,moduleData,caller,activeSectionId,sectionChooserOptions,firstChooserOption,_carousel,searchInput;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(e.target.closest(_selectors.default.actions.optionActions.showSummary)&&(carousel=(0,_jquery.default)(modal.getBody()[0].querySelector(_selectors.default.regions.carousel)),module=e.target.closest(_selectors.default.regions.chooserOption.container),moduleName=module.dataset.modname,(moduleData=mappedModules.get(moduleName)).showFooter=modal.hasFooterContent(),showModuleHelp(carousel,moduleData,modal)),!e.target.closest(_selectors.default.actions.optionActions.manageFavourite)){_context2.next=10;break}return caller=e.target.closest(_selectors.default.actions.optionActions.manageFavourite),_context2.next=5,manageFavouriteState(modal.getBody()[0],caller,partialFavourite);case 5:activeSectionId=modal.getBody()[0].querySelector(_selectors.default.elements.activetab).getAttribute("href"),sectionChooserOptions=modal.getBody()[0].querySelector(_selectors.default.regions.getSectionChooserOptions(activeSectionId)),firstChooserOption=sectionChooserOptions.querySelector(_selectors.default.regions.chooserOption.container),toggleFocusableChooserOption(firstChooserOption,!0),initChooserOptionsKeyboardNavigation(modal.getBody()[0],mappedModules,sectionChooserOptions,modal);case 10:e.target.matches(_selectors.default.actions.closeOption)&&((_carousel=(0,_jquery.default)(modal.getBody()[0].querySelector(_selectors.default.regions.carousel))).carousel("prev"),_carousel.on("slid.bs.carousel",(function(){modal.getBody()[0].querySelector(_selectors.default.regions.modules).querySelector(_selectors.default.regions.getModuleSelector(e.target.dataset.modname)).focus()}))),e.target.closest(_selectors.default.actions.clearSearch)&&((searchInput=modal.getBody()[0].querySelector(_selectors.default.actions.search)).value="",searchInput.focus(),toggleSearchResultsView(modal,mappedModules,searchInput.value));case 12:case"end":return _context2.stop()}}),_callee2)}))),function(_x4){return _ref4.apply(this,arguments)}),footerClickListener=(_ref5=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(e){var footerjs;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(!0!==footerData.footer){_context3.next=6;break}return _context3.next=3,getPlugin(footerData.customfooterjs);case 3:return footerjs=_context3.sent,_context3.next=6,footerjs.footerClickListener(e,footerData,modal);case 6:case"end":return _context3.stop()}}),_callee3)}))),function(_x5){return _ref5.apply(this,arguments)});modal.getBodyPromise().then((function(body){return body[0]})).then((function(body){return(0,_jquery.default)(body.querySelector(_selectors.default.regions.carousel)).carousel({interval:!1,pause:!0,keyboard:!1}),body})).then((function(body){return body.addEventListener("click",bodyClickListener),body})).then((function(body){var searchInput=body.querySelector(_selectors.default.actions.search);return searchInput.addEventListener("input",(0,_utils.debounce)((function(){toggleSearchResultsView(modal,mappedModules,searchInput.value)}),300)),body})).then((function(body){var activeSectionId=body.querySelector(_selectors.default.elements.activetab).getAttribute("href"),sectionChooserOptions=body.querySelector(_selectors.default.regions.getSectionChooserOptions(activeSectionId)),firstChooserOption=sectionChooserOptions.querySelector(_selectors.default.regions.chooserOption.container);return toggleFocusableChooserOption(firstChooserOption,!0),initChooserOptionsKeyboardNavigation(body,mappedModules,sectionChooserOptions,modal),body})).catch(),modal.getFooterPromise().then((function(footer){return footer[0]})).then((function(footer){return footer.addEventListener("click",footerClickListener),footer})).catch()}(modal,mappedModules,partialFavourite,footerData),function(modal,mappedModules){modal.getModal()[0].tabIndex=-1,modal.getBodyPromise().then((function(body){(0,_jquery.default)(_selectors.default.elements.tab).on("shown.bs.tab",(function(e){var activeSectionId=e.target.getAttribute("href"),activeSectionChooserOptions=body[0].querySelector(_selectors.default.regions.getSectionChooserOptions(activeSectionId)),firstChooserOption=activeSectionChooserOptions.querySelector(_selectors.default.regions.chooserOption.container),prevActiveSectionId=e.relatedTarget.getAttribute("href"),prevActiveSectionChooserOptions=body[0].querySelector(_selectors.default.regions.getSectionChooserOptions(prevActiveSectionId));disableFocusAllChooserOptions(prevActiveSectionChooserOptions),toggleFocusableChooserOption(firstChooserOption,!0),initChooserOptionsKeyboardNavigation(body[0],mappedModules,activeSectionChooserOptions,modal)}))})).catch(_notification.default.exception)}(modal,mappedModules),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal})).catch()}}));

//# sourceMappingURL=dialogue.min.js.map