YUI.add("moodle-gradereport_history-userselector",function(T,e){var g="gradereport_history",p={AJAXURL:"ajaxurl",BASE:"base",CHECKBOX_NAME_PREFIX:"usp-u",COURSEID:"courseid",DIALOGUE_PREFIX:"moodle-dialogue",NAME:"gradereport_history_usp",PAGE:"page",PARAMS:"params",PERPAGE:"perPage",SEARCH:"search",SEARCHBTN:"searchbtn",SELECTEDUSERS:"selectedUsers",URL:"url",USERCOUNT:"userCount"},R={ACCESSHIDE:"accesshide",AJAXCONTENT:"usp-ajax-content",CHECKBOX:"usp-checkbox",CLOSE:"close",CLOSEBTN:"usp-finish",CONTENT:"usp-content",DETAILS:"details",EXTRAFIELDS:"extrafields",FIRSTADDED:"usp-first-added",FULLNAME:"fullname",HEADER:"usp-header",HIDDEN:"hidden",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",MORERESULTS:"usp-more-results",OPTIONS:"options",PICTURE:"usp-picture",RESULTSCOUNT:"usp-results-count",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",SEARCHFIELD:"usp-search-field",SEARCHRESULTS:"usp-search-results",SELECTED:"selected",USER:"usp-user",USERS:"usp-users",WRAP:"usp-wrap"},C={AJAXCONTENT:"."+R.AJAXCONTENT,FINISHBTN:"."+R.CLOSEBTN+" input",FIRSTADDED:"."+R.FIRSTADDED,FULLNAME:"."+R.FULLNAME+" label",LIGHTBOX:"."+R.LIGHTBOX,MORERESULTS:"."+R.MORERESULTS,OPTIONS:"."+R.OPTIONS,PICTURE:"."+R.USER+" .userpicture",RESULTSCOUNT:"."+R.RESULTSCOUNT,RESULTSUSERS:"."+R.SEARCHRESULTS+" ."+R.USERS,SEARCHBTN:"."+R.SEARCHBTN,SEARCHFIELD:"."+R.SEARCHFIELD,SELECTEDNAMES:".felement .selectednames",TRIGGER:".gradereport_history_plugin input.selectortrigger",USER:"."+R.USER,USERFULLNAMES:'input[name="userfullnames"]',USERIDS:'input[name="userids"]',USERSELECT:"."+R.CHECKBOX+" input[type=checkbox]"},s=function(){s.superclass.constructor.apply(this,arguments)};T.namespace("M.gradereport_history").UserSelector=T.extend(s,M.core.dialogue,{_firstDisplay:!0,_usersBufferList:null,_userTabFocus:null,_userTemplate:null,initializer:function(){var e=this.get("boundingBox"),s=T.Handlebars.compile('<div class="{{CSS.WRAP}}"><div class="{{CSS.HEADER}}"><div class="{{CSS.SEARCH}}" role="search"><form><input type="text" class="{{CSS.SEARCHFIELD}}" aria-label="{{get_string "search" "moodle"}}" value="" /><input type="submit" class="{{CSS.SEARCHBTN}}"value="{{get_string "search" "moodle"}}"></form><div aria-live="polite" class="{{CSS.RESULTSCOUNT}}">{{get_string "loading" "admin"}}</div></div></div><div class="{{CSS.CONTENT}}"><form><div class="{{CSS.AJAXCONTENT}}" aria-live="polite"></div><div class="{{CSS.LIGHTBOX}} {{CSS.HIDDEN}}"><img class="{{CSS.LOADINGICON}}" alt="{{get_string "loading" "admin"}}"src="{{{loadingIcon}}}"></div><div class="{{CSS.CLOSEBTN}}"><input type="submit" value="{{get_string "finishselectingusers" COMPONENT}}"></div></form></div></div>'),s=T.Node.create(s({COMPONENT:g,CSS:R,loadingIcon:M.util.image_url("i/loading","moodle")}));this.getStdModNode(T.WidgetStdMod.HEADER).prepend(T.Node.create("<h1>"+this.get("title")+"</h1>")),this.setStdModContent(T.WidgetStdMod.BODY,s,T.WidgetStdMod.REPLACE),this.get("boundingBox").one(".moodle-dialogue-wrap").addClass("moodle-dialogue-content"),T.one(C.TRIGGER).on("click",this.show,this),e.one(C.FINISHBTN).on("click",this.finishSelectingUsers,this),e.delegate("key",this.userKeyboardNavigation,"down:38,40",C.AJAXCONTENT,this),T.delegate("click",this.selectUser,C.AJAXCONTENT,C.USERSELECT,this),T.delegate("click",this.selectUser,C.AJAXCONTENT,C.PICTURE,this),(s=this.get(p.PARAMS)).id=this.get(p.COURSEID),this.set(p.PARAMS,s),e.one(C.SEARCHBTN).on("click",this.search,this,!1)},show:function(e){var t;return this._usersBufferList=T.clone(this.get(p.SELECTEDUSERS)),this._firstDisplay?(this._firstDisplay=!1,this.search(e,!1)):((t=this.get("boundingBox")).all(C.USER).each(function(e){this.markUserNode(e,!1)},this),T.Object.each(this._usersBufferList,function(e,s){s=t.one(C.USER+'[data-userid="'+s+'"]');s&&this.markUserNode(s,!0)},this),this.setUserTabFocus(t.one(C.USER))),T.namespace("M.gradereport_history.UserSelector").superclass.show.call(this)},search:function(e,s){e&&e.preventDefault(),s?this.set(p.PAGE,this.get(p.PAGE)+1):(this.set(p.USERCOUNT,0),this.set(p.PAGE,0)),(e=this.get(p.PARAMS)).sesskey=M.cfg.sesskey,e.action="searchusers",e.search=this.get("boundingBox").one(C.SEARCHFIELD).get("value"),e.page=this.get(p.PAGE),e.perpage=this.get(p.PERPAGE),T.io(M.cfg.wwwroot+this.get(p.AJAXURL),{method:"POST",data:window.build_querystring(e),on:{start:this.preSearch,complete:this.processSearchResults,end:this.postSearch},context:this,arguments:{append:s}})},preSearch:function(e,s){var t=this.get("boundingBox");t.one(C.LIGHTBOX).removeClass(R.HIDDEN),s.append||t.one(C.RESULTSCOUNT).setHTML(M.util.get_string("loading","admin"))},postSearch:function(e,s){var t=this.get("boundingBox"),i=t.one(C.FIRSTADDED);t.one(C.LIGHTBOX).addClass(R.HIDDEN),s.append&&i?(this.setUserTabFocus(i),i.one(C.USERSELECT).focus()):(s=t.one(C.USER))&&this.setUserTabFocus(s)},processSearchResults:function(S,e,s){var t,d,i,r,E,a,n,o=!1,u=!1,l=this.get("boundingBox"),c=!0;try{(o=T.JSON.parse(e.responseText)).success&&!o.error||(u=!0)}catch(h){u=!0}if(u)return this.setContent(""),void l.one(C.RESULTSCOUNT).setHTML(M.util.get_string("errajaxsearch",g));for(E in t=s.append?l.one(C.RESULTSUSERS):T.Node.create('<div role="listbox" aria-activedescendant="" aria-multiselectable="true" class="'+R.USERS+'"></div>'),this._userTemplate||(this._userTemplate=T.Handlebars.compile('<div role="option" aria-selected="false" class="{{CSS.USER}} clearfix" data-userid="{{userId}}"><div class="{{CSS.CHECKBOX}}"><input name="{{USP.CHECKBOX_NAME_PREFIX}}{{userId}}" type="checkbox" tabindex="-1"id="{{checkboxId}}" aria-describedby="{{checkboxId}} {{extraFieldsId}}"/></div><div class="{{CSS.PICTURE}}">{{{picture}}}</div><div class="{{CSS.DETAILS}}"><div class="{{CSS.FULLNAME}}"><label for="{{checkboxId}}">{{fullname}}</label></div><div id="{{extraFieldsId}}" class="{{CSS.EXTRAFIELDS}}">{{{extrafields}}}</div></div></div>')),d=this._userTemplate,i=this.get(p.USERCOUNT),r="",o.response.users)i++,n=o.response.users[E],
r=!!T.Object.hasKey(this._usersBufferList,n.userid),n=T.Node.create(d({checkboxId:T.guid(),COMPONENT:g,count:i,CSS:R,extrafields:n.extrafields,extraFieldsId:T.guid(),fullname:n.fullname,picture:n.picture,userId:n.userid,USP:p})),this.markUserNode(n,r),s.append&&c&&(t.all(C.FIRSTADDED).removeClass(R.FIRSTADDED),n.addClass(R.FIRSTADDED),c=!1),t.append(n);this.set(p.USERCOUNT,i),e=parseInt(o.response.totalusers,10),s.append?e<=(this.get(p.PAGE)+1)*this.get(p.PERPAGE)&&l.one(C.MORERESULTS).remove():(0===e?(l.one(C.RESULTSCOUNT).setHTML(M.util.get_string("noresults","moodle")),a=""):(1===e?l.one(C.RESULTSCOUNT).setHTML(M.util.get_string("foundoneuser",g)):l.one(C.RESULTSCOUNT).setHTML(M.util.get_string("foundnusers",g,e)),a=T.Node.create('<div class="'+R.SEARCHRESULTS+'"></div>').append(t),o.response.totalusers>(this.get(p.PAGE)+1)*this.get(p.PERPAGE)&&((u=T.Node.create('<div class="'+R.MORERESULTS+'"><a href="#" role="button">'+M.util.get_string("loadmoreusers",g)+"</a></div>")).one("a").on("click",this.search,this,!0),u.one("a").on("key",this.search,"space",this,!0),a.append(u))),this.setContent(a))},finishSelectingUsers:function(e){e.preventDefault(),this.applySelection(),this.hide()},applySelection:function(){var e=T.Object.keys(this._usersBufferList);this.set(p.SELECTEDUSERS,T.clone(this._usersBufferList)).setNameDisplay(),T.one(C.USERIDS).set("value",e.join())},selectUser:function(e){var s=e.currentTarget.ancestor(C.USER),t=s.one(C.USERSELECT),i=s.one(C.FULLNAME).get("innerHTML"),r=t.get("checked"),a=s.getData("userid");(r=e.currentTarget!==t?!r:r)?this._usersBufferList[a]=i:(delete this._usersBufferList[a],delete this._usersBufferList[parseInt(a,10)]),this.markUserNode(s,r)},markUserNode:function(e,s){return s?e.addClass(R.SELECTED).set("aria-selected",!0).one(C.USERSELECT).set("checked",!0):e.removeClass(R.SELECTED).set("aria-selected",!1).one(C.USERSELECT).set("checked",!1),this},setContent:function(e){return this.get("boundingBox").one(C.AJAXCONTENT).setHTML(e),this},setNameDisplay:function(){var e=T.Object.values(this.get(p.SELECTEDUSERS));T.one(C.SELECTEDNAMES).set("innerHTML",e.join(", ")),T.one(C.USERFULLNAMES).set("value",e.join())},userKeyboardNavigation:function(e){var s=this.get("boundingBox").all(C.USER),t=1,i=e.target.ancestor(C.USER,!0);38===e.keyCode&&(t=-1),(s=this.findFocusableUser(s,i,t))&&(e.preventDefault(),s.one(C.USERSELECT).focus(),this.setUserTabFocus(s))},findFocusableUser:function(e,s,t){s=e.indexOf(s);return e.size()<1?null:s<0?e.item(0):((s+=t)<0?s=e.size()-1:s>=e.size()&&(s=0),e.item(s))},setUserTabFocus:function(e){this._userTabFocus&&this._userTabFocus.setAttribute("tabindex","-1"),e&&(this._userTabFocus=e.one(C.USERSELECT),this._userTabFocus.setAttribute("tabindex","0"),this.get("boundingBox").one(C.RESULTSUSERS).setAttribute("aria-activedescendant",this._userTabFocus.generateID()))}},{NAME:p.NAME,CSS_PREFIX:p.CSS_PREFIX,ATTRS:{title:{validator:T.Lang.isString,valueFn:function(){return M.util.get_string("selectusers",g)}},url:{validator:T.Lang.isString,value:null},ajaxurl:{validator:T.Lang.isString,value:null},selectedUsers:{validator:T.Lang.isObject,value:null,getter:function(e){return null===e?{}:e}},courseid:{value:null},params:{validator:T.Lang.isArray,value:[]},page:{validator:T.Lang.isNumber,value:0},userCount:{value:0,validator:T.Lang.isNumber},perPage:{value:25,Validator:T.Lang.isNumber}}}),T.Base.modifyAttrs(T.namespace("M.gradereport_history.UserSelector"),{extraClasses:{value:["gradereport_history_usp"]},focusOnPreviousTargetAfterHide:{value:!0},width:{value:"500px"},visible:{value:!1},modal:{value:!0},draggable:{value:!0}}),T.namespace("M.gradereport_history.UserSelector").init=function(e){return new s(e)}},"@VERSION@",{requires:["escape","event-delegate","event-key","handlebars","io-base","json-parse","moodle-core-notification-dialogue"]});